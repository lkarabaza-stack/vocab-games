<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Pairs</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg:      var(--tg-theme-bg-color, #f0f4ff);
            --text:    var(--tg-theme-text-color, #111827);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --primary: var(--tg-theme-button-color, #3b82f6);
            --primary-dark: #2563eb;
            --success: #10b981;
            --error:   #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 440px;
            margin-bottom: 12px;
            padding: 10px 16px;
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 1rem;
            font-weight: 600;
        }

        /* â”€â”€ GRID: 2 ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            width: 100%;
            max-width: 440px;
        }

        /* â”€â”€ CARD (Ğ¿Ñ€ÑĞ¼Ğ¾ÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸Ğº, ÑÑ€Ğ°Ğ·Ñƒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°) â”€â”€â”€â”€â”€â”€â”€ */
        .card {
            width: 100%;
            min-height: 52px;
            padding: 12px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            line-height: 1.3;
            word-break: break-word;
            hyphens: auto;
            cursor: pointer;
            border: 2px solid var(--primary);
            background: var(--card-bg);
            color: var(--text);
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            transition: background 0.18s, border-color 0.18s,
                        color 0.18s, transform 0.13s, box-shadow 0.18s;
        }

        .card:active:not(.matched):not(.dealing) {
            transform: scale(0.95);
        }

        /* Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° */
        .card.selected {
            border-color: var(--primary-dark);
            background: color-mix(in srgb, var(--primary) 12%, var(--card-bg));
            box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
            transform: scale(1.04);
        }

        /* Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ */
        .card.matched {
            background: var(--success);
            border-color: var(--success);
            color: #fff;
            box-shadow: 0 4px 12px rgba(16,185,129,0.35);
            cursor: default;
            animation: pop 0.32s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes pop {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        /* ĞÑˆĞ¸Ğ±ĞºĞ° */
        .card.wrong {
            background: var(--error);
            border-color: var(--error);
            color: #fff;
            animation: shake 0.38s ease;
        }

        @keyframes shake {
            0%,100% { transform: translateX(0); }
            20%     { transform: translateX(-6px); }
            60%     { transform: translateX(6px); }
            80%     { transform: translateX(-3px); }
        }

        /* â”€â”€ SHUFFLE / DEAL-IN ANIMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes dealIn {
            0% {
                opacity: 0;
                transform: translateY(-28px) scale(0.82) rotate(var(--r));
            }
            65% {
                transform: translateY(5px) scale(1.05) rotate(0deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotate(0deg);
            }
        }

        .card.dealing {
            animation: dealIn 0.42s cubic-bezier(0.22,1,0.36,1) both;
        }

        /* â”€â”€ WIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #win-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            margin-top: 60px;
            animation: fadeUp 0.5s ease both;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(24px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        #win-screen h1 { font-size: 2.4rem; }
        #win-screen p  { font-size: 1.05rem; opacity: 0.75; }

        .btn {
            margin-top: 4px;
            padding: 12px 32px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(59,130,246,0.38);
            transition: background 0.18s, transform 0.1s;
        }
        .btn:active { transform: scale(0.95); background: var(--primary-dark); }

        /* â”€â”€ ERROR SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #error-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 60px;
            color: var(--error);
            font-size: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="header" id="header">
        <div id="timer">â± 00:00</div>
        <div id="score">ĞŸĞ°Ñ€Ñ‹: 0 / â€”</div>
    </div>

    <div class="grid" id="grid"></div>

    <div id="win-screen">
        <h1>ğŸ‰ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!</h1>
        <p id="final-stats"></p>
        <p>Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ² Telegramâ€¦</p>
        <button class="btn" id="btn-restart">Ğ¡Ñ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°</button>
    </div>

    <div id="error-screen">
        <p>âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹.<br>ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.</p>
    </div>

    <script>
        /* â”€â”€ Telegram SDK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const tg = window.Telegram?.WebApp;
        if (tg) tg.expand();

        /* â”€â”€ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ³Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const urlParams = new URLSearchParams(window.location.search);
        let gameData = [];

        try {
            const raw = urlParams.get('data');
            if (raw) {
                gameData = JSON.parse(decodeURIComponent(raw));
                if (!Array.isArray(gameData) || !gameData.length) throw new Error('empty');
            } else {
                // Ğ”ĞµĞ¼Ğ¾-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
                gameData = [
                    { w: 'Hund',   t: 'Ğ¡Ğ¾Ğ±Ğ°ĞºĞ°'  },
                    { w: 'Katze',  t: 'ĞšĞ¾ÑˆĞºĞ°'   },
                    { w: 'Haus',   t: 'Ğ”Ğ¾Ğ¼'     },
                    { w: 'Auto',   t: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°'  },
                    { w: 'Baum',   t: 'Ğ”ĞµÑ€ĞµĞ²Ğ¾'  },
                    { w: 'Apfel',  t: 'Ğ¯Ğ±Ğ»Ğ¾ĞºĞ¾'  },
                    { w: 'Wasser', t: 'Ğ’Ğ¾Ğ´Ğ°'    },
                    { w: 'Brot',   t: 'Ğ¥Ğ»ĞµĞ±'    }
                ];
            }
        } catch (e) {
            console.error('Data error:', e);
            document.getElementById('header').style.display       = 'none';
            document.getElementById('grid').style.display         = 'none';
            document.getElementById('error-screen').style.display = 'flex';
        }

        const TOTAL_PAIRS = gameData.length;

        /* â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        let timerInterval  = null;
        let secondsElapsed = 0;
        let timerStarted   = false;
        let matchedPairs   = 0;
        let attempts       = 0;
        let selectedCard   = null;
        let lockBoard      = false;

        /* â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const grid         = document.getElementById('grid');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        scoreDisplay.textContent = `ĞŸĞ°Ñ€Ñ‹: 0 / ${TOTAL_PAIRS}`;

        /* â”€â”€ Fisher-Yates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        /* â”€â”€ Ğ¢Ğ°Ğ¹Ğ¼ĞµÑ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function startTimer() {
            if (timerStarted) return;
            timerStarted = true;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                timerDisplay.textContent = `â± ${fmt(secondsElapsed)}`;
            }, 1000);
        }

        function fmt(sec) {
            return `${String(Math.floor(sec / 60)).padStart(2,'0')}:${String(sec % 60).padStart(2,'0')}`;
        }

        /* â”€â”€ ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function buildCards() {
            grid.innerHTML = '';
            lockBoard = true;

            // Ğ›ĞµĞ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° â€” Ğ¸Ğ½Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°, Ğ¿Ñ€Ğ°Ğ²Ğ°Ñ â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹
            // ĞšĞ°Ğ¶Ğ´Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµÑˆĞ°Ğ½Ğ° Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾
            const leftCol  = shuffle(gameData.map((p, i) => ({ id: i, text: p.w })));
            const rightCol = shuffle(gameData.map((p, i) => ({ id: i, text: p.t })));

            // Ğ§ĞµÑ€ĞµĞ´ÑƒĞµĞ¼: left[0], right[0], left[1], right[1]...
            // ĞŸÑ€Ğ¸ grid-template-columns:1fr 1fr ÑÑ‚Ğ¾ Ğ´Ğ°Ñ‘Ñ‚ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
            for (let i = 0; i < TOTAL_PAIRS; i++) {
                [leftCol[i], rightCol[i]].forEach((item, side) => {
                    const card = document.createElement('div');
                    card.classList.add('card', 'dealing');
                    card.dataset.id = item.id;

                    // Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğ¹ Ğ½Ğ°ĞºĞ»Ğ¾Ğ½ Ğ´Ğ»Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ° Ğ±Ñ€Ğ¾ÑĞºĞ°
                    const rot = ((Math.random() * 10) - 5).toFixed(1);
                    card.style.setProperty('--r', rot + 'deg');

                    // stagger: ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‚ÑÑ ÑĞ²ĞµÑ€Ñ…Ñƒ Ğ²Ğ½Ğ¸Ğ·
                    const delay = (i * 2 + side) * 40;
                    card.style.animationDelay = delay + 'ms';

                    card.textContent = item.text;
                    card.addEventListener('click', onCardClick);
                    grid.appendChild(card);
                });
            }

            // Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ½Ñ†Ğ° Ğ²ÑĞµÑ… Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¹
            const totalMs = (TOTAL_PAIRS * 2 - 1) * 40 + 420;
            setTimeout(() => {
                lockBoard = false;
                grid.querySelectorAll('.card').forEach(c => c.classList.remove('dealing'));
            }, totalMs);
        }

        buildCards();

        /* â”€â”€ ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function onCardClick() {
            if (lockBoard || this.classList.contains('matched')) return;
            startTimer();

            // Ğ¡Ğ½ÑÑ‚ÑŒ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¼ ĞºĞ»Ğ¸ĞºĞ¾Ğ¼
            if (this === selectedCard) {
                this.classList.remove('selected');
                selectedCard = null;
                return;
            }

            // ĞŸĞµÑ€Ğ²Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ°
            if (!selectedCard) {
                this.classList.add('selected');
                selectedCard = this;
                return;
            }

            // Ğ’Ñ‚Ğ¾Ñ€Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ°
            const first  = selectedCard;
            const second = this;
            first.classList.remove('selected');
            selectedCard = null;
            attempts++;

            if (first.dataset.id === second.dataset.id) {
                // âœ… Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ
                first.classList.add('matched');
                second.classList.add('matched');
                first.removeEventListener('click', onCardClick);
                second.removeEventListener('click', onCardClick);
                matchedPairs++;
                scoreDisplay.textContent = `ĞŸĞ°Ñ€Ñ‹: ${matchedPairs} / ${TOTAL_PAIRS}`;
                if (tg) tg.HapticFeedback?.impactOccurred('light');
                if (matchedPairs === TOTAL_PAIRS) setTimeout(winGame, 450);
            } else {
                // âŒ ĞÑˆĞ¸Ğ±ĞºĞ°
                lockBoard = true;
                first.classList.add('wrong');
                second.classList.add('wrong');
                if (tg) tg.HapticFeedback?.notificationOccurred('error');
                setTimeout(() => {
                    first.classList.remove('wrong');
                    second.classList.remove('wrong');
                    lockBoard = false;
                }, 700);
            }
        }

        /* â”€â”€ ĞŸĞ¾Ğ±ĞµĞ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function winGame() {
            clearInterval(timerInterval);
            grid.style.display = 'none';
            document.getElementById('header').style.display = 'none';

            const acc = attempts > 0 ? Math.round((TOTAL_PAIRS / attempts) * 100) : 100;
            document.getElementById('final-stats').textContent =
                `Ğ’Ñ€ĞµĞ¼Ñ: ${fmt(secondsElapsed)} Â· Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${acc}%`;
            document.getElementById('win-screen').style.display = 'flex';

            if (tg) tg.HapticFeedback?.notificationOccurred('success');
            setTimeout(() => {
                if (tg) tg.sendData(JSON.stringify({
                    game: 'match_pairs', time_seconds: secondsElapsed,
                    pairs: TOTAL_PAIRS, attempts, accuracy: acc
                }));
            }, 2000);
        }

        /* â”€â”€ Ğ ĞµÑÑ‚Ğ°Ñ€Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.getElementById('btn-restart').addEventListener('click', () => {
            clearInterval(timerInterval);
            secondsElapsed = 0; timerStarted = false;
            matchedPairs   = 0; attempts     = 0;
            selectedCard   = null; lockBoard  = false;

            timerDisplay.textContent = 'â± 00:00';
            scoreDisplay.textContent = `ĞŸĞ°Ñ€Ñ‹: 0 / ${TOTAL_PAIRS}`;

            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('header').style.display     = '';
            grid.style.display = '';
            buildCards();
        });
    </script>
</body>
</html>
