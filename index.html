<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Match Pairs</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg:          var(--tg-theme-bg-color,  #f0f4ff);
    --text:        var(--tg-theme-text-color, #111827);
    --card-bg:     var(--tg-theme-secondary-bg-color, #ffffff);
    --primary:     var(--tg-theme-button-color, #3b82f6);
    --primary-dk:  #2563eb;
    --success:     #38bdf8;
    --match-bdr:   #10b981;
    --error:       #ef4444;
    --xp:          #f59e0b;
    --sprint:      #8b5cf6;
    --sprint-dk:   #7c3aed;
    --bl-bg:       #e8f4ff;
    --bl-cyan:     #4a90e2;
    --bl-pink:     #ff6b9d;
    --bl-yellow:   #ffd93d;
    --bl-green:    #6bcb77;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);color:var(--text);padding:12px;
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;user-select:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#start-screen{
    display:flex;flex-direction:column;align-items:center;
    gap:16px;width:100%;max-width:380px;padding-top:20px;
    animation:fadeUp .4s ease both;
}
#start-screen h1{font-size:2rem;text-align:center;}
.tagline{font-size:.9rem;opacity:.55;text-align:center;}

.mode-toggle{
    display:flex;width:100%;background:var(--card-bg);
    border-radius:14px;padding:4px;gap:4px;
    box-shadow:0 2px 8px rgba(0,0,0,.07);
}
.mode-btn{
    flex:1;padding:10px 6px;border:none;border-radius:10px;
    font-size:.88rem;font-weight:700;cursor:pointer;
    background:transparent;color:var(--text);opacity:.5;
    transition:background .2s,opacity .2s,color .2s;
}
.mode-btn.active-classic{background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;opacity:1;}
.mode-btn.active-sprint {background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;opacity:1;}
.mode-btn.active-blaster{background:linear-gradient(135deg,#00e5ff,#0066aa);color:#05101a;opacity:1;}

.mode-desc{
    width:100%;background:var(--card-bg);border-radius:14px;
    padding:12px 16px;font-size:.86rem;line-height:1.55;
    box-shadow:0 2px 8px rgba(0,0,0,.06);opacity:.8;
}
.level-section{width:100%;display:flex;flex-direction:column;gap:10px;}
.section-label{font-size:.7rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;opacity:.4;margin-bottom:2px;}

.btn-level{
    width:100%;padding:15px 18px;border:none;border-radius:14px;
    font-size:.98rem;font-weight:700;cursor:pointer;
    display:flex;align-items:center;justify-content:space-between;
    transition:transform .12s,box-shadow .12s;
}
.btn-level:active{transform:scale(.97);}
.btn-level.lv1   {background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;box-shadow:0 5px 16px rgba(99,102,241,.35);}
.btn-level.lv2   {background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;box-shadow:0 5px 16px rgba(139,92,246,.35);}
.btn-level.lv3   {background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;box-shadow:0 5px 16px rgba(245,158,11,.35);}
.btn-level.sprint{background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;box-shadow:0 5px 16px rgba(139,92,246,.4);}
.btn-level.blstr {background:linear-gradient(135deg,#00e5ff,#0066aa);color:#05101a;box-shadow:0 5px 20px rgba(0,229,255,.4);}
.btn-level .lv-left{display:flex;flex-direction:column;gap:2px;text-align:left;}
.btn-level .lv-name{font-size:.98rem;}
.btn-level .lv-sub {font-size:.72rem;opacity:.8;font-weight:500;}
.btn-level .lv-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.btn-level .lv-xp   {font-size:.72rem;font-weight:700;background:rgba(255,255,255,.2);padding:2px 8px;border-radius:8px;}
.btn-level .lv-record{font-size:.68rem;opacity:.9;font-weight:600;}
.btn-level.blstr .lv-xp{background:rgba(5,16,26,.15);}

.collect-bar{
    width:100%;display:none;align-items:center;justify-content:space-between;
    gap:10px;padding:12px 16px;
    background:linear-gradient(135deg,#10b981,#059669);
    border-radius:14px;color:#fff;box-shadow:0 4px 16px rgba(16,185,129,.35);
}
.collect-bar.show{display:flex;}
.collect-bar .cb-left{display:flex;flex-direction:column;gap:2px;}
.collect-bar .cb-label{font-size:.7rem;opacity:.82;font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
.collect-bar .cb-xp{font-size:1.4rem;font-weight:800;line-height:1;}
.collect-bar .cb-btn{
    flex-shrink:0;padding:9px 14px;
    background:rgba(255,255,255,.22);border:2px solid rgba(255,255,255,.5);
    color:#fff;border-radius:10px;font-size:.88rem;font-weight:800;
    cursor:pointer;white-space:nowrap;transition:background .15s,transform .1s;
}
.collect-bar .cb-btn:active{background:rgba(255,255,255,.35);transform:scale(.96);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER (classic / sprint)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{
    display:none;justify-content:space-between;align-items:center;
    width:100%;max-width:440px;margin-bottom:12px;
    padding:10px 16px;background:var(--card-bg);
    border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);
    font-size:1.05rem;font-weight:700;
}
.header.visible{display:flex;}
#timer.warn  {color:#f59e0b;}
#timer.danger{color:var(--error);animation:blink .5s ease infinite alternate;}
@keyframes blink{to{opacity:.45;}}
.sprint-pill{
    display:inline-flex;align-items:center;gap:5px;
    background:linear-gradient(135deg,#8b5cf6,#6366f1);
    color:#fff;border-radius:20px;padding:3px 12px;
    font-size:.86rem;font-weight:700;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLASSIC GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.grid{display:none;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:440px;}
.grid.visible{display:grid;}
.grid.lv3 .card{font-size:.9rem;min-height:52px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPRINT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sprint-area{display:none;width:100%;max-width:440px;}
#sprint-area.visible{display:block;}
.sprint-cols{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.sprint-col-label{font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;opacity:.35;text-align:center;margin-bottom:5px;}
.sprint-left,.sprint-right{display:flex;flex-direction:column;gap:7px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{
    width:100%;min-height:56px;padding:11px 9px;
    display:flex;align-items:center;justify-content:center;
    text-align:center;border-radius:12px;font-size:1rem;font-weight:600;
    line-height:1.3;word-break:break-word;hyphens:auto;cursor:pointer;
    border:2px solid var(--primary);background:var(--card-bg);color:var(--text);
    box-shadow:0 2px 6px rgba(0,0,0,.07);
    transition:background .18s,border-color .18s,color .18s,transform .13s,box-shadow .18s;
}
.sprint-left .card{
    border-color:color-mix(in srgb,var(--sprint) 60%,transparent);
    background:color-mix(in srgb,var(--sprint) 7%,var(--card-bg));
}
.card:active:not(.matched):not(.wrong):not(.dealing){transform:scale(.95);}
.card.selected{
    border-color:var(--primary-dk);
    background:color-mix(in srgb,var(--primary) 14%,var(--card-bg));
    box-shadow:0 0 0 3px rgba(59,130,246,.25);transform:scale(1.04);
}
.sprint-left .card.selected{
    border-color:var(--sprint-dk);
    background:color-mix(in srgb,var(--sprint) 18%,var(--card-bg));
    box-shadow:0 0 0 3px rgba(139,92,246,.25);
}
.card.matched{
    background:var(--success);border-color:var(--match-bdr);color:#111827;
    box-shadow:0 4px 12px rgba(56,189,248,.4);cursor:default;
    animation:pop .32s cubic-bezier(.34,1.56,.64,1);
}
.card.wrong{background:var(--error);border-color:var(--error);color:#fff;animation:shake .38s ease;}
@keyframes pop  {0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}60%{transform:translateX(6px)}80%{transform:translateX(-3px)}}
@keyframes dealIn{0%{opacity:0;transform:translateY(-28px) scale(.82) rotate(var(--r))}65%{transform:translateY(5px) scale(1.05) rotate(0deg)}100%{opacity:1;transform:translateY(0) scale(1) rotate(0deg)}}
.card.dealing{animation:dealIn .42s cubic-bezier(.22,1,.36,1) both;}
@keyframes slideIn{from{opacity:0;transform:translateY(-14px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes slideOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(10px) scale(.9)}}
.card.slide-in{animation:slideIn .28s cubic-bezier(.22,1,.36,1) both;}
.card.slide-out{animation:slideOut .2s ease both;pointer-events:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#win-screen{
    display:none;flex-direction:column;align-items:center;
    gap:14px;margin-top:36px;animation:fadeUp .5s ease both;
    text-align:center;width:100%;max-width:360px;
}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
#win-screen h1{font-size:2.2rem;}
.xp-card{
    width:100%;background:var(--card-bg);border-radius:16px;
    padding:16px 20px;box-shadow:0 4px 16px rgba(0,0,0,.08);
    display:flex;flex-direction:column;gap:10px;
}
.xp-card-title{font-size:.73rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;opacity:.4;}
.xp-row{display:flex;justify-content:space-between;align-items:center;font-size:.93rem;}
.xp-row .label{opacity:.62;}
.xp-row .val{font-weight:700;}
.xp-row .val.bonus{color:var(--xp);}
.xp-row.total{border-top:1px solid rgba(0,0,0,.08);padding-top:8px;font-size:1.03rem;}
.xp-row.total .val{color:var(--match-bdr);font-size:1.2rem;}
.session-xp{
    width:100%;background:linear-gradient(135deg,#10b981,#059669);
    border-radius:14px;padding:14px 20px;
    display:flex;align-items:center;justify-content:space-between;color:#fff;
}
.session-xp .s-label{font-size:.83rem;opacity:.85;}
.session-xp .s-total{font-size:1.8rem;font-weight:800;line-height:1;}
.record-banner{
    display:none;align-items:center;gap:10px;
    background:linear-gradient(135deg,#f59e0b,#ef4444);
    color:#fff;border-radius:12px;padding:12px 16px;
    font-weight:800;font-size:1rem;width:100%;
}
.record-banner.show{display:flex;animation:recordPop .5s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes recordPop{0%{transform:scale(.7);opacity:0}100%{transform:scale(1);opacity:1}}
.record-banner .rec-icon{font-size:1.5rem;}
.record-banner .rec-text{display:flex;flex-direction:column;gap:1px;}
.record-banner .rec-title{font-size:.7rem;opacity:.85;font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
.record-banner .rec-val{font-size:1.04rem;font-weight:800;}
.level-badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 14px;border-radius:20px;font-size:.84rem;font-weight:700;color:#fff;
}
.level-badge.lv1   {background:linear-gradient(135deg,#3b82f6,#6366f1);}
.level-badge.lv2   {background:linear-gradient(135deg,#8b5cf6,#ec4899);}
.level-badge.lv3   {background:linear-gradient(135deg,#f59e0b,#ef4444);}
.level-badge.sprint{background:linear-gradient(135deg,#8b5cf6,#6366f1);}
.level-badge.blstr {background:linear-gradient(135deg,#00e5ff,#0066aa);color:#05101a;}
.win-buttons{display:flex;flex-direction:column;gap:10px;width:100%;}
.btn-collect{
    width:100%;padding:14px 20px;
    background:linear-gradient(135deg,#10b981,#059669);
    color:#fff;border:none;border-radius:14px;font-size:1.02rem;font-weight:800;
    cursor:pointer;box-shadow:0 6px 20px rgba(16,185,129,.4);
    transition:transform .12s,box-shadow .12s;
}
.btn-collect:active{transform:scale(.97);}
.btn{
    padding:13px 20px;background:var(--primary);color:#fff;border:none;
    border-radius:12px;font-size:.97rem;font-weight:700;cursor:pointer;
    box-shadow:0 4px 14px rgba(59,130,246,.38);transition:background .18s,transform .1s;
}
.btn:active{transform:scale(.95);background:var(--primary-dk);}
.btn-outline{
    padding:11px 20px;background:transparent;color:var(--primary);
    border:2px solid var(--primary);border-radius:12px;font-size:.92rem;
    font-weight:700;cursor:pointer;transition:background .18s,transform .1s;
}
.btn-outline:active{transform:scale(.95);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI (classic/sprint wins)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.confetti-piece{position:fixed;pointer-events:none;z-index:9999;border-radius:2px;animation:confettiFall var(--dur) var(--ease) var(--delay) forwards;}
@keyframes confettiFall{0%{transform:translate(0,0) rotate(0deg) scale(1);opacity:1;}80%{opacity:1;}100%{transform:translate(var(--tx),var(--ty)) rotate(var(--rot)) scale(.4);opacity:0;}}
.burst-ring{position:fixed;border-radius:50%;pointer-events:none;z-index:9998;border:3px solid var(--ring-color,#f59e0b);animation:burstRing .6s ease-out forwards;}
@keyframes burstRing{0%{transform:translate(-50%,-50%) scale(0);opacity:.9;}100%{transform:translate(-50%,-50%) scale(1);opacity:0;}}
.star-burst{position:fixed;pointer-events:none;z-index:9999;font-size:1.4rem;animation:starFly var(--dur) ease var(--delay) forwards;}
@keyframes starFly{0%{transform:translate(0,0) scale(0) rotate(0deg);opacity:1;}40%{transform:translate(var(--tx),var(--ty)) scale(1.3) rotate(var(--rot));opacity:1;}100%{transform:translate(calc(var(--tx)*1.6),calc(var(--ty)*1.6)) scale(0) rotate(calc(var(--rot)*2));opacity:0;}}
.xp-float{position:fixed;pointer-events:none;font-size:1.1rem;font-weight:800;color:var(--xp);text-shadow:0 1px 4px rgba(0,0,0,.15);animation:floatUp .9s ease forwards;z-index:100;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}80%{opacity:1;}100%{opacity:0;transform:translateY(-60px) scale(1.2);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BLASTER OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#blaster-wrap{
    display:none;position:fixed;inset:0;z-index:50;
    background:linear-gradient(180deg,#c9eeff 0%,#e8f8ff 50%,#d4f0d4 100%);
    touch-action:none;
}
#blaster-wrap.visible{display:block;}
#blaster-wrap::before{
    content:'';position:absolute;inset:0;z-index:0;pointer-events:none;
    background-image:radial-gradient(circle at 20% 30%, rgba(255,255,255,.6) 0%, transparent 50%),
                     radial-gradient(circle at 80% 70%, rgba(200,240,255,.5) 0%, transparent 50%);
}
#bl-canvas{position:absolute;inset:0;z-index:1;width:100%;height:100%;}

/* Blaster HUD */
#bl-hud{
    position:absolute;top:0;left:0;right:0;z-index:10;
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 16px 6px;
    background:linear-gradient(180deg,rgba(232,248,255,.95) 80%,transparent);
    font-family:'Exo 2',sans-serif;
}
.bl-box{display:flex;flex-direction:column;align-items:center;gap:1px;}
.bl-lbl{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:#4a90e2;opacity:.8;font-weight:700;}
.bl-val{font-size:1.05rem;font-weight:700;color:#1a3a5c;}
/* Blaster word */
#bl-word-panel{
    position:absolute;left:50%;transform:translateX(-50%);
    top:74px;z-index:10;text-align:center;white-space:nowrap;
}
.bl-word-lbl{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:#ff6b9d;opacity:.9;font-weight:700;}
#bl-word{
    font-family:'Exo 2',sans-serif;font-size:1.6rem;font-weight:800;
    color:#1a3a5c;text-shadow:0 2px 4px rgba(255,255,255,.8);
    letter-spacing:.02em;
}

/* Combo */
#bl-combo{
    position:absolute;top:126px;left:50%;transform:translateX(-50%);z-index:10;
    font-family:'Exo 2',sans-serif;font-size:.95rem;font-weight:900;
    color:#d4700a;text-shadow:0 2px 4px rgba(255,255,255,.7);
    white-space:nowrap;display:none;
}
/* Flash */
#bl-flash{position:absolute;inset:0;z-index:9;pointer-events:none;opacity:0;transition:opacity .08s;background:rgba(255,80,80,.2);}

/* Error */

/* â”€â”€ Sound toggle button â”€â”€ */
#btn-sound {
    position:fixed; top:14px; right:14px; z-index:200;
    width:40px; height:40px; border-radius:50%;
    border:2px solid rgba(0,0,0,.12);
    background:var(--card-bg);
    font-size:1.2rem; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 2px 8px rgba(0,0,0,.10);
    transition:background .15s, transform .1s, opacity .2s;
    opacity:.75;
}
#btn-sound:active { transform:scale(.92); }
#btn-sound.muted  { opacity:.45; }
/* hide during blaster (has its own dark bg) */
.bl-sound-btn {
    position:absolute; top:12px; right:12px; z-index:60;
    width:38px; height:38px; border-radius:50%;
    border:1.5px solid rgba(100,160,255,.35);
    background:rgba(10,30,60,.55);
    font-size:1.1rem; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    backdrop-filter:blur(4px);
    transition:background .15s, transform .1s;
}
.bl-sound-btn:active { transform:scale(.92); }

#error-screen{display:none;flex-direction:column;align-items:center;gap:10px;margin-top:60px;color:var(--error);font-size:1rem;text-align:center;}
</style>
</head>
<body>

<!-- â•â•â• SOUND TOGGLE â•â•â• -->
<button id="btn-sound" title="Ğ—Ğ²ÑƒĞº">ğŸ”Š</button>

<!-- â•â•â• START SCREEN â•â•â• -->
<div id="start-screen">
    <div><h1>ğŸ§  Match Pairs</h1><p class="tagline">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¸ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ</p></div>

    <div class="mode-toggle">
        <button class="mode-btn active-classic" id="btn-mc" onclick="setMode('classic')">ğŸ¯ ĞšĞ»Ğ°ÑÑĞ¸ĞºĞ°</button>
        <button class="mode-btn"               id="btn-ms" onclick="setMode('sprint')">âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚</button>
        <button class="mode-btn"               id="btn-mb" onclick="setMode('blaster')">ğŸ’¥ Ğ‘Ğ»Ğ°ÑÑ‚ĞµÑ€</button>
    </div>

    <div class="mode-desc" id="mode-desc"></div>

    <div class="level-section" id="lbs-classic">
        <div class="section-label">Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸</div>
        <button class="btn-level lv1" data-pairs="4" data-mode="classic">
            <span class="lv-left"><span class="lv-name">â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹</span><span class="lv-sub">4 Ğ¿Ğ°Ñ€Ñ‹</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 15 XP</span><span class="lv-record" id="rc4"></span></span>
        </button>
        <button class="btn-level lv2" data-pairs="6" data-mode="classic">
            <span class="lv-left"><span class="lv-name">â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹</span><span class="lv-sub">6 Ğ¿Ğ°Ñ€</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 25 XP</span><span class="lv-record" id="rc6"></span></span>
        </button>
        <button class="btn-level lv3" data-pairs="8" data-mode="classic">
            <span class="lv-left"><span class="lv-name">â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹</span><span class="lv-sub">8 Ğ¿Ğ°Ñ€</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 35 XP</span><span class="lv-record" id="rc8"></span></span>
        </button>
    </div>

    <div class="level-section" id="lbs-sprint" style="display:none">
        <div class="section-label">60 ÑĞµĞºÑƒĞ½Ğ´ Â· Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº</div>
        <button class="btn-level lv1" data-mode="sprint" data-rows="3">
            <span class="lv-left"><span class="lv-name">â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹</span><span class="lv-sub">3 Ğ¿Ğ°Ñ€Ñ‹ Â· Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 40 XP</span><span class="lv-record" id="rcs3"></span></span>
        </button>
        <button class="btn-level lv2" data-mode="sprint" data-rows="6">
            <span class="lv-left"><span class="lv-name">â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹</span><span class="lv-sub">6 Ğ¿Ğ°Ñ€ Â· Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 50 XP</span><span class="lv-record" id="rcs6"></span></span>
        </button>
        <button class="btn-level lv3" data-mode="sprint" data-rows="8">
            <span class="lv-left"><span class="lv-name">â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹</span><span class="lv-sub">8 Ğ¿Ğ°Ñ€ Â· Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 60 XP</span><span class="lv-record" id="rcs8"></span></span>
        </button>
    </div>

    <div class="level-section" id="lbs-blaster" style="display:none">
        <div class="section-label">60 ÑĞµĞºÑƒĞ½Ğ´ Â· Ğ°Ñ€ĞºĞ°Ğ´Ğ°</div>
        <button class="btn-level blstr" data-mode="blaster">
            <span class="lv-left"><span class="lv-name">ğŸ«§ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ</span><span class="lv-sub">4â†’6 Ğ¿ÑƒĞ·Ñ‹Ñ€ĞµĞ¹ Â· ĞºĞ¾Ğ¼Ğ±Ğ¾ Â· Ñ€Ğ¾Ğ³Ğ°Ñ‚ĞºĞ°</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 60+ XP</span><span class="lv-record" id="rcb"></span></span>
        </button>
    </div>

    <div class="collect-bar" id="collect-bar">
        <div class="cb-left">
            <span class="cb-label">ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾ Ğ·Ğ° ÑĞµÑÑĞ¸Ñ</span>
            <span class="cb-xp"><span id="cb-val">0</span> XP</span>
        </div>
        <button class="cb-btn" id="btn-collect-start">ğŸ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
</div>

<!-- â•â•â• CLASSIC/SPRINT HEADER â•â•â• -->
<div class="header" id="header">
    <div id="timer">â± 00:00</div>
    <div id="level-label"></div>
    <div id="score">ĞŸĞ°Ñ€Ñ‹: 0 / â€”</div>
</div>

<!-- â•â•â• CLASSIC GRID â•â•â• -->
<div class="grid" id="grid"></div>

<!-- â•â•â• SPRINT AREA â•â•â• -->
<div id="sprint-area">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:5px">
        <div class="sprint-col-label">Ğ¡Ğ»Ğ¾Ğ²Ğ¾</div>
        <div class="sprint-col-label">ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´</div>
    </div>
    <div class="sprint-cols">
        <div class="sprint-left"  id="sprint-left"></div>
        <div class="sprint-right" id="sprint-right"></div>
    </div>
</div>

<!-- â•â•â• WIN SCREEN â•â•â• -->
<div id="win-screen">
    <h1 id="win-title">ğŸ‰ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!</h1>
    <div id="win-badge" class="level-badge"></div>
    <div class="xp-card">
        <div class="xp-card-title">XP Ğ·Ğ° ÑÑ‚Ğ¾Ñ‚ Ñ€Ğ°ÑƒĞ½Ğ´</div>
        <div class="xp-row" id="row-base">
            <span class="label">Ğ‘Ğ°Ğ·Ğ°</span>
            <span class="val" id="xp-base">0 XP</span>
        </div>
        <div class="xp-row" id="row-acc">
            <span class="label">Ã— Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ (<span id="xp-acc-pct">0</span>%)</span>
            <span class="val" id="xp-acc-val">0 XP</span>
        </div>
        <div class="xp-row" id="row-bonus">
            <span class="label" id="bonus-label">âš¡ Ğ‘Ğ¾Ğ½ÑƒÑ</span>
            <span class="val bonus" id="xp-bonus">+0 XP</span>
        </div>
        <div class="xp-row" id="row-record" style="display:none">
            <span class="label">ğŸ† Ğ‘Ğ¾Ğ½ÑƒÑ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ°</span>
            <span class="val bonus">+20 XP</span>
        </div>
        <div class="xp-row total">
            <span class="label"><b>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ·Ğ° Ñ€Ğ°ÑƒĞ½Ğ´</b></span>
            <span class="val" id="xp-total">0 XP</span>
        </div>
    </div>
    <div class="session-xp">
        <div><div class="s-label">ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾ Ğ·Ğ° ÑĞµÑÑĞ¸Ñ</div><div class="s-total" id="sess-total">0 XP</div></div>
        <div style="font-size:2rem">ğŸ†</div>
    </div>
    <div class="record-banner" id="record-banner">
        <span class="rec-icon">ğŸ†</span>
        <span class="rec-text">
            <span class="rec-title">ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!</span>
            <span class="rec-val" id="record-val"></span>
        </span>
    </div>
    <p style="font-size:.93rem;opacity:.7" id="final-stats"></p>
    <div class="win-buttons">
        <button class="btn-collect" id="btn-collect">ğŸ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ <span id="collect-label">0</span> XP Ğ¸ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸</button>
        <button class="btn"         id="btn-restart">â–¶ Ğ¡Ñ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°</button>
        <button class="btn-outline" id="btn-menu">â† Ğ’ Ğ¼ĞµĞ½Ñ</button>
    </div>
</div>

<div id="error-screen">
    <p>âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.<br>ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.</p>
</div>

<!-- â•â•â• BLASTER OVERLAY â•â•â• -->
<div id="blaster-wrap">
    <canvas id="bl-canvas"></canvas>
    <div id="bl-hud">
        <div class="bl-box"><span class="bl-lbl">Ğ¡Ñ‡Ñ‘Ñ‚</span><span class="bl-val" id="bl-score">0</span></div>
        <div class="bl-box">
            <svg viewBox="0 0 48 48" width="46" height="46">
                <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(0,229,255,.15)" stroke-width="4"/>
                <circle id="bl-arc" cx="24" cy="24" r="20" fill="none" stroke="#00e5ff" stroke-width="4"
                        stroke-dasharray="125.6" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-90 24 24)"/>
                <text x="24" y="29" text-anchor="middle" font-family="Orbitron,monospace"
                      font-size="11" font-weight="700" fill="white" id="bl-time-txt">60</text>
            </svg>
        </div>
        <div class="bl-box"><span class="bl-lbl">Ğ¡Ğ»Ğ¾Ğ²Ğ°</span><span class="bl-val" id="bl-words">0</span></div>
    </div>
    <div id="bl-combo"></div>
    <div id="bl-word-panel">
        <div class="bl-word-lbl">ĞŸĞµÑ€ĞµĞ²ĞµĞ´Ğ¸ ÑĞ»Ğ¾Ğ²Ğ¾</div>
        <div id="bl-word">â€”</div>
    </div>
    <div id="bl-flash"></div>
    <button class="bl-sound-btn" id="btn-sound-bl" title="Ğ—Ğ²ÑƒĞº">ğŸ”Š</button>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TELEGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let allData = [];
try {
    const raw = new URLSearchParams(window.location.search).get('data');
    if (raw) {
        allData = JSON.parse(decodeURIComponent(raw));
        if (!Array.isArray(allData) || !allData.length) throw 0;
    } else {
        allData = [
            {w:'Hund',t:'Ğ¡Ğ¾Ğ±Ğ°ĞºĞ°'},{w:'Katze',t:'ĞšĞ¾ÑˆĞºĞ°'},{w:'Haus',t:'Ğ”Ğ¾Ğ¼'},
            {w:'Auto',t:'ĞœĞ°ÑˆĞ¸Ğ½Ğ°'},{w:'Baum',t:'Ğ”ĞµÑ€ĞµĞ²Ğ¾'},{w:'Apfel',t:'Ğ¯Ğ±Ğ»Ğ¾ĞºĞ¾'},
            {w:'Wasser',t:'Ğ’Ğ¾Ğ´Ğ°'},{w:'Brot',t:'Ğ¥Ğ»ĞµĞ±'},{w:'Schule',t:'Ğ¨ĞºĞ¾Ğ»Ğ°'},
            {w:'Buch',t:'ĞšĞ½Ğ¸Ğ³Ğ°'},{w:'Kind',t:'Ğ ĞµĞ±Ñ‘Ğ½Ğ¾Ğº'},{w:'Freund',t:'Ğ”Ñ€ÑƒĞ³'},
            {w:'Tisch',t:'Ğ¡Ñ‚Ğ¾Ğ»'},{w:'Stuhl',t:'Ğ¡Ñ‚ÑƒĞ»'},{w:'Stadt',t:'Ğ“Ğ¾Ñ€Ğ¾Ğ´'},
            {w:'Land',t:'Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ°'},{w:'Sonne',t:'Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğµ'},{w:'Mond',t:'Ğ›ÑƒĞ½Ğ°'},
            {w:'Feuer',t:'ĞĞ³Ğ¾Ğ½ÑŒ'},{w:'Eis',t:'Ğ›Ñ‘Ğ´'},
        ];
    }
} catch(e) {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('error-screen').style.display = 'flex';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shuffle(a) {
    const b=[...a];
    for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]];}
    return b;
}
function pickWords(n) { return shuffle(allData).slice(0, Math.min(n, allData.length)); }
function fmt(s) { return `${String(0|s/60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function rnd(a,b) { return a + Math.random()*(b-a); }
function levelInfo(p) {
    if(p<=4) return {cls:'lv1',label:'â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹',gcls:''};
    if(p<=6) return {cls:'lv2',label:'â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹',gcls:''};
    return         {cls:'lv3',label:'â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹',gcls:'lv3'};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECORDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RKEY = 'mp_records_v3';
function getRecs()    { try{ return JSON.parse(localStorage.getItem(RKEY))||{}; }catch{return{};} }
function saveRec(k,v) { const r=getRecs(); r[k]=v; localStorage.setItem(RKEY,JSON.stringify(r)); }
function getBest(k)   { return getRecs()[k]??null; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION XP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sessionXP = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   XP CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const XP_CL = { 4:{base:10,spd:5,sec:15}, 6:{base:15,spd:10,sec:25}, 8:{base:20,spd:15,sec:35} };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MODE_DESCS = {
    classic: '<b>ğŸ¯ ĞšĞ»Ğ°ÑÑĞ¸ĞºĞ°</b> â€” Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ²ÑĞµ Ğ¿Ğ°Ñ€Ñ‹. Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ²Ñ€ĞµĞ¼Ñ Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ. Ğ§ĞµĞ¼ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ â€” Ñ‚ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ XP.',
    sprint:  '<b>âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚</b> â€” 60 ÑĞµĞºÑƒĞ½Ğ´, Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº ÑĞ»Ğ¾Ğ². Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ: 3, 6 Ğ¸Ğ»Ğ¸ 8 Ğ¿Ğ°Ñ€ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾. Ğ£Ğ³Ğ°Ğ´Ğ°Ğ¹ ĞºĞ°Ğº Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ!',
    blaster: '<b>ğŸ«§ Ğ‘Ğ»Ğ°ÑÑ‚ĞµÑ€</b> â€” 60 ÑĞµĞºÑƒĞ½Ğ´! ĞœÑ‹Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ÑƒĞ·Ñ‹Ñ€Ğ¸ Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°Ğ¼Ğ¸ Ğ»ĞµÑ‚Ğ°ÑÑ‚ Ğ¿Ğ¾ ÑĞºÑ€Ğ°Ğ½Ñƒ. ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ â€” Ñ€Ğ¾Ğ³Ğ°Ñ‚ĞºĞ° ÑÑ‚Ñ€ĞµĞ»ÑĞµÑ‚ Ğ¸ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒ Ğ»Ğ¾Ğ¿Ğ°ĞµÑ‚ÑÑ! ĞšĞ¾Ğ¼Ğ±Ğ¾ Ã— Ğ´Ğ¾ Ã—2.0.',
};
let currentMode = 'classic';
let currentPairs = 4;

function setMode(m) {
    currentMode = m;
    document.getElementById('btn-mc').className = 'mode-btn'+(m==='classic' ?' active-classic':'');
    document.getElementById('btn-ms').className = 'mode-btn'+(m==='sprint'  ?' active-sprint' :'');
    document.getElementById('btn-mb').className = 'mode-btn'+(m==='blaster' ?' active-blaster':'');
    document.getElementById('mode-desc').innerHTML = MODE_DESCS[m]||'';
    document.getElementById('lbs-classic').style.display = m==='classic' ?'':'none';
    document.getElementById('lbs-sprint').style.display  = m==='sprint'  ?'':'none';
    document.getElementById('lbs-blaster').style.display = m==='blaster' ?'':'none';
}
setMode('classic');
updateRecordLabels();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECORD LABELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateRecordLabels() {
    const map = {rc4:'cl-4',rc6:'cl-6',rc8:'cl-8',rcs:'sprint',rcb:'blaster'};
    for(const [id,key] of Object.entries(map)) {
        const el=document.getElementById(id); if(!el) continue;
        const v=getBest(key);
        if(v===null){el.textContent='';continue;}
        el.textContent = (key.startsWith('sprint')||key==='blaster') ? `ğŸ† ${v} ÑĞ»Ğ¾Ğ²` : `ğŸ† ${fmt(v)}`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEVEL BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.btn-level').forEach(btn => {
    btn.addEventListener('click', () => {
        const m = btn.dataset.mode;
        const p = parseInt(btn.dataset.pairs)||8;
        const rows = parseInt(btn.dataset.rows)||8;
        if(m==='classic') startClassic(p);
        else if(m==='sprint') startSprint(rows);
        else startBlaster();
    });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HIDE ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hideAll() {
    document.getElementById('start-screen').style.display='none';
    document.getElementById('win-screen').style.display='none';
    document.getElementById('header').classList.remove('visible');
    document.getElementById('grid').className='grid';
    document.getElementById('sprint-area').classList.remove('visible');
    document.getElementById('sprint-left').innerHTML='';
    document.getElementById('sprint-right').innerHTML='';
    document.getElementById('blaster-wrap').classList.remove('visible');
}

function goToMenu() {
    blasterStop();
    clearInterval(classicTimer);
    clearInterval(sprintTimer);
    hideAll();
    document.getElementById('start-screen').style.display='flex';
    updateRecordLabels();
    syncCollectBar();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLECT BAR (start screen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncCollectBar() {
    const bar=document.getElementById('collect-bar');
    document.getElementById('cb-val').textContent=sessionXP;
    sessionXP>0 ? bar.classList.add('show') : bar.classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED WIN SCREEN FILL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showWin({title,badgeCls,badgeText,base,showAcc,acc,bonusLabel,bonus,recBonus,roundXP,stats,isNew,recVal}) {
    sessionXP += roundXP;
    document.getElementById('win-title').textContent = title;
    const badge=document.getElementById('win-badge');
    badge.textContent=badgeText; badge.className=`level-badge ${badgeCls}`;
    document.getElementById('xp-base').textContent   = `${base} XP`;
    document.getElementById('row-acc').style.display = showAcc?'':'none';
    document.getElementById('xp-acc-pct').textContent = acc;
    document.getElementById('xp-acc-val').textContent = `${Math.round(base*(acc/100))} XP`;
    document.getElementById('bonus-label').textContent = bonusLabel;
    document.getElementById('xp-bonus').textContent   = `+${bonus} XP`;
    document.getElementById('row-record').style.display = isNew?'':'none';
    document.getElementById('xp-total').textContent  = `+${roundXP} XP`;
    document.getElementById('sess-total').textContent = `${sessionXP} XP`;
    document.getElementById('collect-label').textContent = sessionXP;
    document.getElementById('final-stats').textContent = stats;
    const banner=document.getElementById('record-banner');
    if(isNew){
        document.getElementById('record-val').textContent=recVal;
        banner.classList.add('show');
    } else banner.classList.remove('show');
    document.getElementById('win-screen').style.display='flex';
    updateRecordLabels();
    if(tg) tg.HapticFeedback?.notificationOccurred(isNew?'success':'warning');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CC=['#f59e0b','#ef4444','#3b82f6','#10b981','#8b5cf6','#ec4899','#38bdf8','#fff'];
const CS=['â­','ğŸŒŸ','âœ¨','ğŸ’«','ğŸ‰','ğŸ†'];
function launchConfetti(cx,cy,n=60){
    for(let i=0;i<n;i++){
        const el=document.createElement('div');el.classList.add('confetti-piece');
        const ang=rnd(0,Math.PI*2),pow=rnd(120,380);
        const tx=Math.cos(ang)*pow,ty=Math.sin(ang)*pow-rnd(80,200);
        const dur=rnd(.7,1.4),delay=rnd(0,.18),sz=rnd(7,14);
        const circ=Math.random()>.5;
        el.style.cssText=`left:${cx}px;top:${cy}px;width:${sz}px;height:${sz*(circ?1:rnd(.4,1))}px;
            background:${CC[0|Math.random()*CC.length]};border-radius:${circ?'50%':'2px'};
            --tx:${tx}px;--ty:${ty}px;--rot:${rnd(-720,720)}deg;--dur:${dur}s;--delay:${delay}s;--ease:ease-out;`;
        document.body.appendChild(el);
        setTimeout(()=>el.remove(),(dur+delay)*1000+100);
    }
}
function launchRing(cx,cy,color,sz=160){
    const el=document.createElement('div');el.classList.add('burst-ring');
    el.style.cssText=`left:${cx}px;top:${cy}px;width:${sz}px;height:${sz}px;--ring-color:${color};`;
    document.body.appendChild(el);setTimeout(()=>el.remove(),700);
}
function launchStars(cx,cy,n=8){
    for(let i=0;i<n;i++){
        const el=document.createElement('div');el.classList.add('star-burst');
        const ang=(Math.PI*2/n)*i,pow=rnd(80,160);
        const dur=rnd(.6,1),delay=rnd(0,.1);
        el.textContent=CS[0|Math.random()*CS.length];
        el.style.cssText=`left:${cx}px;top:${cy}px;--tx:${Math.cos(ang)*pow}px;--ty:${Math.sin(ang)*pow}px;--rot:${rnd(-180,180)}deg;--dur:${dur}s;--delay:${delay}s;`;
        document.body.appendChild(el);setTimeout(()=>el.remove(),(dur+delay)*1000+100);
    }
}
function celebrateRecord(){
    const cx=innerWidth/2,cy=innerHeight/2;
    launchRing(cx,cy,'#f59e0b',200);launchStars(cx,cy,10);launchConfetti(cx,cy,70);
    setTimeout(()=>{launchRing(cx*.3,cy*.6,'#3b82f6',120);launchConfetti(cx*.3,cy*.6,30);},180);
    setTimeout(()=>{launchRing(cx*1.7,cy*.6,'#ec4899',120);launchConfetti(cx*1.7,cy*.6,30);},320);
    setTimeout(()=>{launchStars(cx,cy*.3,8);launchConfetti(cx,cy*.8,40);},500);
}
function celebrateWin(){
    const cx=innerWidth/2,cy=innerHeight/2;
    launchRing(cx,cy,'#38bdf8',160);launchConfetti(cx,cy,45);launchStars(cx,cy,6);
}
function spawnXPFloat(el,txt){
    const r=el.getBoundingClientRect();
    const d=document.createElement('div');d.classList.add('xp-float');
    d.textContent=txt;d.style.left=r.left+r.width/2-20+'px';d.style.top=r.top+scrollY-10+'px';
    document.body.appendChild(d);setTimeout(()=>d.remove(),950);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  CLASSIC MODE  â–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let classicTimer=null, classicSecs=0, classicStarted=false;
let matchedPairs=0, attempts=0;
let selectedCard=null, lockBoard=false;
let gameData=[];

function startClassic(pairs) {
    currentMode='classic'; currentPairs=pairs;
    gameData=pickWords(pairs);
    clearInterval(classicTimer);
    classicSecs=0; classicStarted=false; matchedPairs=0; attempts=0;
    selectedCard=null; lockBoard=false;
    const info=levelInfo(pairs);
    hideAll();
    document.getElementById('header').classList.add('visible');
    const g=document.getElementById('grid');
    g.className='grid visible'+(info.gcls?' '+info.gcls:'');
    document.getElementById('timer').textContent='â± 00:00';
    document.getElementById('timer').className='';
    document.getElementById('score').textContent=`ĞŸĞ°Ñ€Ñ‹: 0 / ${pairs}`;
    document.getElementById('level-label').textContent=info.label;
    buildClassicCards();
}
function buildClassicCards(){
    const g=document.getElementById('grid');
    g.innerHTML='';lockBoard=true;
    const L=shuffle(gameData.map((p,i)=>({id:i,t:p.w})));
    const R=shuffle(gameData.map((p,i)=>({id:i,t:p.t})));
    for(let i=0;i<gameData.length;i++){
        [L[i],R[i]].forEach((item,s)=>{
            const c=document.createElement('div');
            c.classList.add('card','dealing');c.dataset.id=item.id;
            c.style.setProperty('--r',rnd(-5,5).toFixed(1)+'deg');
            c.style.animationDelay=(i*2+s)*40+'ms';
            c.textContent=item.t;c.addEventListener('click',onClassicClick);
            g.appendChild(c);
        });
    }
    setTimeout(()=>{lockBoard=false;g.querySelectorAll('.card').forEach(c=>c.classList.remove('dealing'));},(gameData.length*2-1)*40+420);
}
function startClassicTimer(){
    if(classicStarted) return; classicStarted=true;
    classicTimer=setInterval(()=>{
        classicSecs++;
        document.getElementById('timer').textContent=`â± ${fmt(classicSecs)}`;
    },1000);
}
function onClassicClick(){
    if(lockBoard||this.classList.contains('matched')) return;
    startClassicTimer();
    if(this===selectedCard){this.classList.remove('selected');selectedCard=null;return;}
    if(!selectedCard){this.classList.add('selected');selectedCard=this;sndCardFlip();return;}
    const A=selectedCard,B=this;
    A.classList.remove('selected');selectedCard=null;attempts++;
    if(A.dataset.id===B.dataset.id){
        A.classList.add('matched');B.classList.add('matched');
        A.removeEventListener('click',onClassicClick);B.removeEventListener('click',onClassicClick);
        matchedPairs++;
        document.getElementById('score').textContent=`ĞŸĞ°Ñ€Ñ‹: ${matchedPairs} / ${currentPairs}`;
        sndMatch();
        if(tg) tg.HapticFeedback?.impactOccurred('light');
        spawnXPFloat(B,'âœ¨');
        if(matchedPairs===currentPairs) setTimeout(winClassic,450);
    } else {
        lockBoard=true;A.classList.add('wrong');B.classList.add('wrong');
        sndMismatch();
        if(tg) tg.HapticFeedback?.notificationOccurred('error');
        setTimeout(()=>{A.classList.remove('wrong');B.classList.remove('wrong');lockBoard=false;},700);
    }
}
function winClassic(){
    clearInterval(classicTimer);
    sndWin();
    document.getElementById('header').classList.remove('visible');
    document.getElementById('grid').className='grid';
    const acc=attempts>0?Math.round(currentPairs/attempts*100):100;
    const cfg=XP_CL[currentPairs]||XP_CL[8];
    const key=`cl-${currentPairs}`;
    const prev=getBest(key);
    const isNew=prev===null||classicSecs<prev;
    if(isNew) saveRec(key,classicSecs);
    const earned=Math.round(cfg.base*(acc/100));
    const spd=classicSecs<=cfg.sec?cfg.spd:0;
    const roundXP=earned+spd+(isNew?20:0);
    const info=levelInfo(currentPairs);
    showWin({
        title:'ğŸ‰ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!',badgeCls:info.cls,badgeText:info.label,
        base:cfg.base,showAcc:true,acc,bonusLabel:'âš¡ Ğ‘Ğ¾Ğ½ÑƒÑ Ğ·Ğ° ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ',bonus:spd,
        recBonus:20,roundXP,
        stats:`Ğ’Ñ€ĞµĞ¼Ñ: ${fmt(classicSecs)} Â· Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${acc}% Â· Ğ ĞµĞºĞ¾Ñ€Ğ´: ${fmt(getBest(key))}`,
        isNew,recVal:`${fmt(classicSecs)}${prev!==null?` (Ğ±Ñ‹Ğ»Ğ¾ ${fmt(prev)})`:'  (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!)'}`,
    });
    isNew?setTimeout(celebrateRecord,120):celebrateWin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  SPRINT MODE  â–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let SPRINT_ROWS=8;
let sprintTimer=null,sprintLeft2=0,sprintStarted=false;
let sprintScore=0,sprintAttempts=0,sprintQueue2=[],sprintQPos=0;
let sprintSlots=[],sprintSelL=null,sprintSelR=null;

function startSprint(rows){
    SPRINT_ROWS=rows||8;
    currentMode='sprint';
    clearInterval(sprintTimer);
    sprintLeft2=60;sprintStarted=false;sprintScore=0;sprintAttempts=0;
    sprintSelL=null;sprintSelR=null;
    sprintQueue2=shuffle(allData.map((_,i)=>i));sprintQPos=0;
    hideAll();
    document.getElementById('header').classList.add('visible');
    document.getElementById('sprint-area').classList.add('visible');
    document.getElementById('timer').textContent='â± 1:00';
    document.getElementById('timer').className='';
    document.getElementById('score').innerHTML='<span class="sprint-pill">âš¡ <span id="sp-score">0</span> Ğ¿Ğ°Ñ€</span>';
    const lvLabel=SPRINT_ROWS===3?'â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹':SPRINT_ROWS===6?'â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹':'â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹';
    document.getElementById('level-label').textContent=`âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚ Â· ${lvLabel}`;
    const SL=document.getElementById('sprint-left'),SR=document.getElementById('sprint-right');
    SL.innerHTML='';SR.innerHTML='';sprintSlots=[];
    for(let i=0;i<SPRINT_ROWS;i++){
        const id=nextSprintId();
        const el=makeSpCard(allData[id].w,'left',i*30);
        el.addEventListener('click',()=>onSprintL(i));
        SL.appendChild(el);sprintSlots.push({id,el});
    }
    rebuildSprintRight(sprintSlots.map(s=>s.id));
    document.getElementById('sprint-area').addEventListener('click',startSprintTimer,{once:true});
}
function nextSprintId(){
    if(sprintQPos>=sprintQueue2.length){sprintQueue2=shuffle(allData.map((_,i)=>i));sprintQPos=0;}
    return sprintQueue2[sprintQPos++];
}
function makeSpCard(text,side,delay=0){
    const el=document.createElement('div');
    el.classList.add('card','slide-in');
    el.style.animationDelay=delay+'ms';
    el.textContent=text;
    setTimeout(()=>el.classList.remove('slide-in'),delay+300);
    return el;
}
function rebuildSprintRight(ids){
    const SR=document.getElementById('sprint-right');
    SR.innerHTML='';
    shuffle([...ids]).forEach((id,i)=>{
        const el=makeSpCard(allData[id].t,'right',i*30);
        el.addEventListener('click',()=>onSprintR(id,el));
        SR.appendChild(el);
    });
}
function onSprintL(idx){
    if(!sprintStarted||lockBoard) return;
    const slot=sprintSlots[idx];
    if(!slot||slot.el.classList.contains('matched')) return;
    if(sprintSelL?.idx===idx){slot.el.classList.remove('selected');sprintSelL=null;return;}
    if(sprintSelL) sprintSelL.el.classList.remove('selected');
    sprintSelL={idx,id:slot.id,el:slot.el};slot.el.classList.add('selected');
    if(sprintSelR) checkSprintPair();
}
function onSprintR(id,el){
    if(!sprintStarted||lockBoard||el.classList.contains('matched')) return;
    if(sprintSelR?.el===el){el.classList.remove('selected');sprintSelR=null;return;}
    if(sprintSelR) sprintSelR.el.classList.remove('selected');
    sprintSelR={id,el};el.classList.add('selected');
    if(sprintSelL) checkSprintPair();
}
function checkSprintPair(){
    const L=sprintSelL,R=sprintSelR;
    L.el.classList.remove('selected');R.el.classList.remove('selected');
    sprintSelL=null;sprintSelR=null;sprintAttempts++;
    if(L.id===R.id){
        L.el.classList.add('matched');R.el.classList.add('matched');
        sprintScore++;
        const sv=document.getElementById('sp-score');if(sv)sv.textContent=sprintScore;
        sndMatch();
        if(tg) tg.HapticFeedback?.impactOccurred('light');
        spawnXPFloat(R.el,'âœ¨');
        setTimeout(()=>replaceSprintSlot(L.idx,L.el,R.el),650);
    } else {
        lockBoard=true;L.el.classList.add('wrong');R.el.classList.add('wrong');
        sndMismatch();
        if(tg) tg.HapticFeedback?.notificationOccurred('error');
        setTimeout(()=>{L.el.classList.remove('wrong');R.el.classList.remove('wrong');lockBoard=false;},600);
    }
}
function replaceSprintSlot(idx,oldL,matchedR){
    matchedR.classList.add('slide-out');setTimeout(()=>matchedR.remove(),220);
    oldL.classList.add('slide-out');
    const newId=nextSprintId();
    setTimeout(()=>{
        const newEl=makeSpCard(allData[newId].w,'left');
        newEl.addEventListener('click',()=>onSprintL(idx));
        document.getElementById('sprint-left').replaceChild(newEl,oldL);
        sprintSlots[idx]={id:newId,el:newEl};
        const newR=makeSpCard(allData[newId].t,'right');
        newR.addEventListener('click',()=>onSprintR(newId,newR));
        const SR=document.getElementById('sprint-right');
        const kids=[...SR.children].filter(c=>!c.classList.contains('slide-out'));
        const before=kids[0|Math.random()*(kids.length+1)];
        if(before)SR.insertBefore(newR,before);else SR.appendChild(newR);
    },220);
}
function startSprintTimer(){
    sprintStarted=true;lockBoard=false;
    sprintTimer=setInterval(()=>{
        sprintLeft2--;
        const m=0|sprintLeft2/60,s=String(sprintLeft2%60).padStart(2,'0');
        const td=document.getElementById('timer');
        td.textContent=`â± ${m}:${s}`;
        td.classList.toggle('warn',sprintLeft2<=20&&sprintLeft2>10);
        td.classList.toggle('danger',sprintLeft2<=10);
        if(sprintLeft2<=10 && sprintLeft2>0) sndSprintTick();
        if(sprintLeft2<=0) endSprint();
    },1000);
}
function endSprint(){
    clearInterval(sprintTimer);
    sndWin();
    document.getElementById('header').classList.remove('visible');
    document.getElementById('sprint-area').classList.remove('visible');
    const spKey=`sprint-${SPRINT_ROWS}`;
    const prev=getBest(spKey);
    const isNew=prev===null||sprintScore>prev;
    if(isNew) saveRec(spKey,sprintScore);
    const acc=sprintAttempts>0?Math.round(sprintScore/sprintAttempts*100):0;
    const baseXP=SPRINT_ROWS===3?20:SPRINT_ROWS===6?30:40;
    const roundXP=baseXP+sprintScore+(isNew?20:0);
    const lvLabel=SPRINT_ROWS===3?'â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹':SPRINT_ROWS===6?'â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹':'â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹';
    showWin({
        title:'â° Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾!',badgeCls:'sprint',badgeText:`âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚ Â· ${lvLabel}`,
        base:baseXP,showAcc:false,acc,bonusLabel:'âš¡ Ğ‘Ğ¾Ğ½ÑƒÑ Ğ·Ğ° Ğ¿Ğ°Ñ€Ñ‹',bonus:sprintScore,
        recBonus:20,roundXP,
        stats:`Ğ£Ğ³Ğ°Ğ´Ğ°Ğ½Ğ¾: ${sprintScore} Ğ¿Ğ°Ñ€ Â· Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${acc}% Â· Ğ ĞµĞºĞ¾Ñ€Ğ´: ${getBest(spKey)} ÑĞ»Ğ¾Ğ²`,
        isNew,recVal:`${sprintScore} Ğ¿Ğ°Ñ€${prev!==null?` (Ğ±Ñ‹Ğ»Ğ¾ ${prev})`:'  (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!)'}`,
    });
    if(isNew){sndRecord();setTimeout(celebrateRecord,120);}else{sndWin();celebrateWin();}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  BLASTER MODE  â–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BL_SECS    = 60;
const BALL_ZONES = {top:148, bottom:110};
const BL_COLORS  = [
    {fill:'#a8d8f0',glow:'#6ab4e8',text:'#1a3a5c',rim:'#e8f8ff'},
    {fill:'#f0b8d8',glow:'#e87aaa',text:'#5c1a3a',rim:'#fff0f8'},
    {fill:'#f0e8a8',glow:'#d4c040',text:'#3a3000',rim:'#fffff0'},
    {fill:'#a8f0c8',glow:'#50d090',text:'#0a3a20',rim:'#f0fff8'},
    {fill:'#c8a8f0',glow:'#a060e0',text:'#2a0a5c',rim:'#f8f0ff'},
    {fill:'#f0c8a8',glow:'#e09050',text:'#3a1a00',rim:'#fff8f0'},
];

/* â”€â”€ Audio â”€â”€ */
let _sndCtx = null;
let soundEnabled = true;
function sndCtx() {
    if (!_sndCtx) _sndCtx = new (window.AudioContext||window.webkitAudioContext)();
    return _sndCtx;
}
function sndTone(freq, type, vol, dur, attack=0.005, fadeStart=0.6) {
    if(!soundEnabled) return;
    try {
        const ac = sndCtx();
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.connect(gain); gain.connect(ac.destination);
        osc.type = type; osc.frequency.setValueAtTime(freq, ac.currentTime);
        gain.gain.setValueAtTime(0, ac.currentTime);
        gain.gain.linearRampToValueAtTime(vol, ac.currentTime + attack);
        gain.gain.setValueAtTime(vol, ac.currentTime + dur * fadeStart);
        gain.gain.linearRampToValueAtTime(0, ac.currentTime + dur);
        osc.start(ac.currentTime); osc.stop(ac.currentTime + dur);
    } catch(e) {}
}
function sndNoise(vol, dur) {
    if(!soundEnabled) return;
    try {
        const ac = sndCtx();
        const buf = ac.createBuffer(1, ac.sampleRate * dur, ac.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = (Math.random()*2-1);
        const src = ac.createBufferSource();
        const gain = ac.createGain();
        const filt = ac.createBiquadFilter();
        filt.type = 'bandpass'; filt.frequency.value = 800; filt.Q.value = 0.8;
        src.buffer = buf;
        src.connect(filt); filt.connect(gain); gain.connect(ac.destination);
        gain.gain.setValueAtTime(vol, ac.currentTime);
        gain.gain.linearRampToValueAtTime(0, ac.currentTime + dur);
        src.start(); src.stop(ac.currentTime + dur);
    } catch(e) {}
}
function blSndPop(col) {
    // bubble pop â€” short noise burst + high sine
    sndNoise(0.18, 0.12);
    sndTone(900 + Math.random()*400, 'sine', 0.12, 0.15, 0.002);
    sndTone(1400 + Math.random()*300, 'sine', 0.07, 0.10, 0.001);
}
function blSndWrong() {
    sndTone(220, 'sawtooth', 0.15, 0.18);
    sndTone(180, 'sawtooth', 0.10, 0.14, 0.01);
}
function blSndLaser() {
    if(!soundEnabled) return;
    try {
        const ac = sndCtx();
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.connect(gain); gain.connect(ac.destination);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(900, ac.currentTime);
        osc.frequency.exponentialRampToValueAtTime(200, ac.currentTime + 0.18);
        gain.gain.setValueAtTime(0.18, ac.currentTime);
        gain.gain.linearRampToValueAtTime(0, ac.currentTime + 0.18);
        osc.start(ac.currentTime); osc.stop(ac.currentTime + 0.2);
    } catch(e) {}
}
function blSndCombo(level) {
    const freqs = [523, 659, 784, 1047];
    const f = freqs[Math.min(level-1, freqs.length-1)];
    sndTone(f, 'sine', 0.13, 0.2);
    setTimeout(() => sndTone(f*1.5, 'sine', 0.08, 0.15), 80);
}
function blSndTick() {
    sndTone(1200, 'square', 0.06, 0.05, 0.001, 0.5);
}
function blSndGameover() {
    [400,320,260,200].forEach((f,i)=>setTimeout(()=>sndTone(f,'sawtooth',0.15,0.25),i*120));
}


/* â”€â”€ Shared sound helpers â”€â”€ */
function sndMatch() {
    if(!soundEnabled) return;
    sndTone(523, 'sine', 0.12, 0.12, 0.003);
    setTimeout(()=>sndTone(659, 'sine', 0.09, 0.10, 0.003), 70);
}
function sndMismatch() {
    if(!soundEnabled) return;
    sndTone(260, 'sawtooth', 0.13, 0.14, 0.008);
}
function sndWin() {
    if(!soundEnabled) return;
    [523,659,784,1047].forEach((f,i)=>setTimeout(()=>sndTone(f,'sine',0.13,0.22,0.005),i*90));
}
function sndRecord() {
    if(!soundEnabled) return;
    [523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>sndTone(f,'sine',0.15,0.25,0.005),i*75));
}
function sndCardFlip() {
    if(!soundEnabled) return;
    sndTone(800, 'sine', 0.07, 0.06, 0.002, 0.4);
}
function sndSprintTick() {
    if(!soundEnabled) return;
    sndTone(1100, 'square', 0.05, 0.04, 0.001, 0.5);
}

/* â”€â”€ State â”€â”€ */
let blCanvas, blCtx, blW, blH;
let blRunning=false, blTimeLeft=BL_SECS, blTicker=null;
let blScore=0, blWords=0, blShots=0, blCombo=0, blMaxCombo=0;
let blWordQueue=[], blQPos=0, blCurIdx=0;
let blBalls=[], blParticles=[], blLaser=null;
let blCannon={x:0,y:0,angle:0,targetAngle:0,flash:0};
let blRAF=null, blLastT=0;
let blPrevTime=BL_SECS;

/* â”€â”€ Init / Resize â”€â”€ */
function blInit(){
    blCanvas=document.getElementById('bl-canvas');
    blCtx=blCanvas.getContext('2d');
    blResize();
    window.addEventListener('resize',blResize);
    blCanvas.addEventListener('pointerdown',blOnTap);
}
function blResize(){
    if(!blCanvas) return;
    blW=blCanvas.width=window.innerWidth;
    blH=blCanvas.height=window.innerHeight;
}

/* â”€â”€ Start / Stop â”€â”€ */
function startBlaster(){
    currentMode='blaster';
    if(!blCanvas) blInit();
    blRunning=false;cancelAnimationFrame(blRAF);clearInterval(blTicker);
    blScore=0;blWords=0;blShots=0;blCombo=0;blMaxCombo=0;
    blBalls=[];blParticles=[];blLaser=null;blTimeLeft=BL_SECS;blPrevTime=BL_SECS;
    blWordQueue=shuffle(allData.map((_,i)=>i));blQPos=0;
    hideAll();
    document.getElementById('blaster-wrap').classList.add('visible');
    blResize();
    document.getElementById('bl-score').textContent='0';
    document.getElementById('bl-words').textContent='0';
    document.getElementById('bl-combo').style.display='none';
    blUpdateTimer();blNextWord();
    blRunning=true;
    blTicker=setInterval(()=>{
        blTimeLeft--;blUpdateTimer();
        if(blTimeLeft<=10 && blTimeLeft!==blPrevTime) blSndTick();
        blPrevTime=blTimeLeft;
        if(blTimeLeft<=0) blEnd();
    },1000);
    blLastT=performance.now();
    blRAF=requestAnimationFrame(blLoop);
}
function blStop(){
    blRunning=false;cancelAnimationFrame(blRAF);clearInterval(blTicker);
    document.getElementById('blaster-wrap').classList.remove('visible');
}
function blasterStop(){blStop();}

/* â”€â”€ Word queue â”€â”€ */
function blNextWordId(){
    if(blQPos>=blWordQueue.length){blWordQueue=shuffle(allData.map((_,i)=>i));blQPos=0;}
    return blWordQueue[blQPos++];
}
function blNextWord(){
    blCurIdx=blNextWordId();
    document.getElementById('bl-word').textContent=allData[blCurIdx].w;
    blSpawnBalls();
}

/* â”€â”€ Balls with separation physics â”€â”€ */
const BL_R = 72;
function blBallCount(){ const e=BL_SECS-blTimeLeft;return e<20?4:e<40?5:6; }
function blBallSpeed(){ return 1+(BL_SECS-blTimeLeft)*0.016; }

function blSpawnBalls(){
    const n=blBallCount(), sm=blBallSpeed();
    const wrong=shuffle(allData.filter((_,i)=>i!==blCurIdx).map(d=>d.t)).slice(0,n-1);
    const cols=shuffle([...BL_COLORS]).slice(0,n);
    const cpos=0|Math.random()*n;
    blBalls=[]; let wi=0;

    // place balls without overlap using simple grid + jitter
    const topPad = BALL_ZONES.top + BL_R + 14;
    const botPad = blH - BALL_ZONES.bottom - BL_R - 14;
    const playH  = Math.max(botPad - topPad, BL_R*2);
    const playW  = blW - BL_R*2 - 20;

    const positions = [];
    for(let attempt=0;attempt<n;attempt++){
        let best={x:0,y:0}, bestDist=0;
        for(let t=0;t<30;t++){
            const cx = BL_R+10 + Math.random()*playW;
            const cy = topPad + Math.random()*playH;
            let minD = Infinity;
            for(const p of positions) minD=Math.min(minD, Math.hypot(cx-p.x,cy-p.y));
            if(positions.length===0) minD=9999;
            if(minD>bestDist){bestDist=minD;best={x:cx,y:cy};}
        }
        positions.push(best);
    }

    for(let i=0;i<n;i++){
        const isCor=i===cpos;
        const txt=isCor?allData[blCurIdx].t:wrong[wi++];
        const {x:bx,y:by}=positions[i];
        blBalls.push({
            id:i,text:txt,correct:isCor,col:cols[i],r:BL_R,
            x:bx,y:by,vx:(Math.random()-.5)*1.2,vy:(Math.random()-.5)*1.2,
            ax:32+Math.random()*40,ay:20+Math.random()*28,
            fx:0.35+Math.random()*0.5,fy:0.3+Math.random()*0.45,
            px:Math.random()*Math.PI*2,py:Math.random()*Math.PI*2,
            t:0,sm,opacity:0,pulse:0,shakeX:0,
        });
    }
}

function blUpdateBalls(dt){
    // sinusoidal drift + velocity
    for(const b of blBalls){
        b.t += dt*b.sm;
        b.opacity = Math.min(1, b.opacity + dt*3.5);
        // base drift
        const tx = b.x + Math.sin(b.t*b.fx+b.px)*b.ax*0.012;
        const ty = b.y + Math.cos(b.t*b.fy+b.py)*b.ay*0.012;
        b.vx += (tx-b.x)*0.08; b.vy += (ty-b.y)*0.08;
        b.vx *= 0.88; b.vy *= 0.88;
        b.x += b.vx; b.y += b.vy;
        // wall bounce
        const ml=b.r+8, mr=blW-b.r-8;
        const mt=BALL_ZONES.top+b.r+8, mb=blH-BALL_ZONES.bottom-b.r-8;
        if(b.x<ml){b.x=ml;b.vx=Math.abs(b.vx)*0.6;}
        if(b.x>mr){b.x=mr;b.vx=-Math.abs(b.vx)*0.6;}
        if(b.y<mt){b.y=mt;b.vy=Math.abs(b.vy)*0.6;}
        if(b.y>mb){b.y=mb;b.vy=-Math.abs(b.vy)*0.6;}
        if(b.correct) b.pulse=Math.sin(Date.now()*0.004)*0.055;
    }

    // ball-to-ball repulsion (prevent overlap)
    for(let i=0;i<blBalls.length;i++){
        for(let j=i+1;j<blBalls.length;j++){
            const a=blBalls[i], b=blBalls[j];
            const dx=b.x-a.x, dy=b.y-a.y;
            const dist=Math.hypot(dx,dy)||0.001;
            const minDist=a.r+b.r+6;
            if(dist<minDist){
                const push=(minDist-dist)/minDist*0.55;
                const nx=dx/dist, ny=dy/dist;
                a.vx -= nx*push*2.5; a.vy -= ny*push*2.5;
                b.vx += nx*push*2.5; b.vy += ny*push*2.5;
                // also separate positions directly
                const sep=(minDist-dist)*0.5;
                a.x-=nx*sep; a.y-=ny*sep;
                b.x+=nx*sep; b.y+=ny*sep;
            }
        }
    }
}

/* â”€â”€ Draw bubble â”€â”€ */
function blDrawBubble(ctx, x, y, r, col, text) {
    ctx.save();
    ctx.shadowColor = col.glow; ctx.shadowBlur = 20;
    // body
    const body = ctx.createRadialGradient(x-r*.25, y-r*.3, r*.04, x, y, r);
    body.addColorStop(0, col.rim + 'dd'); body.addColorStop(0.35, col.fill + 'bb');
    body.addColorStop(0.8, col.fill + '77'); body.addColorStop(1, col.glow + '44');
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.fillStyle = body; ctx.fill(); ctx.shadowBlur = 0;
    // rainbow rim
    const rim = ctx.createLinearGradient(x-r, y-r, x+r, y+r);
    rim.addColorStop(0,'rgba(255,160,160,.6)'); rim.addColorStop(0.25,'rgba(160,255,160,.5)');
    rim.addColorStop(0.5,'rgba(160,160,255,.6)'); rim.addColorStop(0.75,'rgba(255,255,160,.5)');
    rim.addColorStop(1,'rgba(255,160,255,.6)');
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2);
    ctx.strokeStyle = rim; ctx.lineWidth = r*0.09; ctx.stroke();
    // top-left highlight
    const hi = ctx.createRadialGradient(x-r*.35, y-r*.38, 0, x-r*.22, y-r*.26, r*.5);
    hi.addColorStop(0,'rgba(255,255,255,.9)'); hi.addColorStop(.5,'rgba(255,255,255,.2)');
    hi.addColorStop(1,'rgba(255,255,255,0)');
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fillStyle=hi; ctx.fill();
    // bottom-right shimmer
    const hi2 = ctx.createRadialGradient(x+r*.32, y+r*.32, 0, x+r*.32, y+r*.32, r*.2);
    hi2.addColorStop(0,'rgba(255,255,255,.55)'); hi2.addColorStop(1,'rgba(255,255,255,0)');
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fillStyle=hi2; ctx.fill();
    // text multiline
    if(text){
        ctx.fillStyle = col.text; ctx.textAlign='center'; ctx.textBaseline='middle';
        const maxC = Math.max(4, Math.floor(r/6));
        const words2 = text.split(' ');
        const lines = []; let cur='';
        for(const w of words2){
            if((cur+(cur?' ':'')+w).length>maxC&&cur){lines.push(cur);cur=w;}
            else cur+=(cur?' ':'')+w;
        }
        if(cur) lines.push(cur);
        if(lines.length===1&&lines[0].length>maxC+2){
            const s=lines[0];lines.length=0;
            for(let i=0;i<s.length;i+=maxC) lines.push(s.slice(i,i+maxC));
        }
        const fz = Math.max(10, Math.min(16, Math.floor(r*0.40)-(lines.length>1?(lines.length-1)*2:0)));
        ctx.font=`700 ${fz}px 'Exo 2',sans-serif`;
        const lh=fz*1.22, totalH=lines.length*lh;
        lines.forEach((line,i)=>ctx.fillText(line, x, y-totalH/2+lh*(i+.5)));
    }
    ctx.restore();
}

function blDrawBalls(){
    for(const b of blBalls){
        blCtx.save(); blCtx.globalAlpha=b.opacity;
        const r=b.r*(1+b.pulse);
        blDrawBubble(blCtx, b.x+b.shakeX, b.y, r, b.col, b.text);
        blCtx.restore();
    }
}

/* â”€â”€ Cannon on semicircle â”€â”€ */
function blDrawCannon(){
    const cx=blW/2, cy=blH; // bottom centre
    const arcR=72;           // radius of the semicircle rail
    // blCannon.y used for laser origin
    const tipX=cx+Math.sin(blCannon.angle)*arcR;
    const tipY=cy-Math.cos(blCannon.angle)*arcR;
    blCannon.x=tipX; blCannon.y=tipY;
    blCannon.angle+=(blCannon.targetAngle-blCannon.angle)*.22;

    blCtx.save(); blCtx.translate(cx,cy);

    // semicircle rail
    blCtx.beginPath(); blCtx.arc(0,0,arcR,Math.PI,0,false);
    blCtx.strokeStyle='rgba(60,120,200,.35)'; blCtx.lineWidth=6;
    blCtx.shadowBlur=12; blCtx.shadowColor='rgba(80,160,255,.5)'; blCtx.stroke();
    blCtx.shadowBlur=0;
    // rail inner highlight
    blCtx.beginPath(); blCtx.arc(0,0,arcR-3,Math.PI,0,false);
    blCtx.strokeStyle='rgba(180,220,255,.2)'; blCtx.lineWidth=2; blCtx.stroke();

    // cannon body rides on the rail
    blCtx.save(); blCtx.rotate(blCannon.angle);
    blCtx.translate(0,-arcR); // move to rail position

    // base disk
    const diskG=blCtx.createRadialGradient(0,0,2,0,0,16);
    diskG.addColorStop(0,'#3a7acc'); diskG.addColorStop(1,'#1a3a6a');
    blCtx.beginPath(); blCtx.arc(0,0,16,0,Math.PI*2);
    blCtx.fillStyle=diskG;
    blCtx.shadowBlur=14; blCtx.shadowColor='rgba(100,180,255,.7)'; blCtx.fill(); blCtx.shadowBlur=0;
    blCtx.strokeStyle='rgba(150,210,255,.55)'; blCtx.lineWidth=2; blCtx.stroke();

    // barrel (pointing up = toward angle)
    const barG=blCtx.createLinearGradient(-7,0,7,0);
    barG.addColorStop(0,'#0d2a4a'); barG.addColorStop(.45,'#2060a0'); barG.addColorStop(1,'#0d2a4a');
    blCtx.beginPath(); blCtx.roundRect(-7,-46,14,34,3);
    blCtx.fillStyle=barG;
    blCtx.shadowBlur=12; blCtx.shadowColor='rgba(100,180,255,.5)'; blCtx.fill(); blCtx.shadowBlur=0;
    blCtx.strokeStyle='rgba(120,190,255,.4)'; blCtx.lineWidth=1.2; blCtx.stroke();
    // stripe details
    for(let s=0;s<2;s++){
        blCtx.beginPath(); blCtx.moveTo(-7,-18-s*10); blCtx.lineTo(7,-18-s*10);
        blCtx.strokeStyle='rgba(160,220,255,.25)'; blCtx.lineWidth=2; blCtx.stroke();
    }
    // muzzle ring
    blCtx.beginPath(); blCtx.roundRect(-9,-52,18,9,3);
    blCtx.fillStyle='#1e5090'; blCtx.fill();
    blCtx.strokeStyle='rgba(120,200,255,.55)'; blCtx.lineWidth=1.2; blCtx.stroke();

    // flash
    if(blCannon.flash>0){
        const fG=blCtx.createRadialGradient(0,-50,0,0,-50,22);
        fG.addColorStop(0,`rgba(255,255,255,${blCannon.flash})`);
        fG.addColorStop(.3,`rgba(120,210,255,${blCannon.flash*.9})`);
        fG.addColorStop(1,'transparent');
        blCtx.beginPath(); blCtx.arc(0,-50,22,0,Math.PI*2);
        blCtx.fillStyle=fG; blCtx.fill();
        blCtx.save(); blCtx.globalAlpha=blCannon.flash*.65;
        blCtx.strokeStyle='#bef'; blCtx.lineWidth=1.5;
        blCtx.beginPath(); blCtx.moveTo(0,-66); blCtx.lineTo(0,-36); blCtx.stroke();
        blCtx.beginPath(); blCtx.moveTo(-15,-50); blCtx.lineTo(15,-50); blCtx.stroke();
        blCtx.restore();
        blCannon.flash=Math.max(0,blCannon.flash-.10);
    } else {
        const idleG=blCtx.createRadialGradient(0,-50,0,0,-50,7);
        idleG.addColorStop(0,'rgba(120,210,255,.6)'); idleG.addColorStop(1,'transparent');
        blCtx.beginPath(); blCtx.arc(0,-50,7,0,Math.PI*2); blCtx.fillStyle=idleG; blCtx.fill();
    }
    blCtx.restore(); // undo rotate+translate to rail
    blCtx.restore(); // undo translate(cx,cy)
}

/* â”€â”€ Laser â”€â”€ */
function blFireLaser(tx,ty,col){
    blLaser={x1:blCannon.x,y1:blCannon.y,x2:tx,y2:ty,col,life:1};
    blCannon.flash=1;
    blSndLaser();
}
function blDrawLaser(){
    if(!blLaser) return;
    blCtx.save();
    const alpha=blLaser.life;
    const dx=blLaser.x2-blLaser.x1, dy=blLaser.y2-blLaser.y1;
    // outer glow
    blCtx.globalAlpha=alpha*.5; blCtx.strokeStyle='rgba(100,200,255,1)';
    blCtx.lineWidth=14; blCtx.lineCap='round';
    blCtx.shadowBlur=28; blCtx.shadowColor='rgba(100,200,255,.9)';
    blCtx.beginPath(); blCtx.moveTo(blLaser.x1,blLaser.y1); blCtx.lineTo(blLaser.x2,blLaser.y2); blCtx.stroke();
    // mid
    blCtx.globalAlpha=alpha*.85; blCtx.strokeStyle='rgba(200,235,255,1)';
    blCtx.lineWidth=6; blCtx.shadowBlur=16;
    blCtx.beginPath(); blCtx.moveTo(blLaser.x1,blLaser.y1); blCtx.lineTo(blLaser.x2,blLaser.y2); blCtx.stroke();
    // core
    blCtx.globalAlpha=alpha; blCtx.strokeStyle='#ffffff';
    blCtx.lineWidth=2.5; blCtx.shadowBlur=8; blCtx.shadowColor='#fff';
    blCtx.beginPath(); blCtx.moveTo(blLaser.x1,blLaser.y1); blCtx.lineTo(blLaser.x2,blLaser.y2); blCtx.stroke();
    // sparkles along beam
    blCtx.shadowBlur=0;
    for(let t=0.08;t<1;t+=0.12+Math.random()*0.1){
        blCtx.globalAlpha=alpha*(0.3+Math.random()*.6);
        blCtx.fillStyle='rgba(200,240,255,1)';
        blCtx.beginPath();
        blCtx.arc(blLaser.x1+dx*t+(Math.random()-.5)*7, blLaser.y1+dy*t+(Math.random()-.5)*7,
                  1+Math.random()*2.5, 0, Math.PI*2); blCtx.fill();
    }
    blCtx.restore();
    blLaser.life-=.10; if(blLaser.life<=0) blLaser=null;
}

/* â”€â”€ Particles â”€â”€ */
class BlPart {
    constructor(x,y,col,letter,fast=false){
        this.x=x; this.y=y; this.col=col; this.letter=letter||'';
        const ang=Math.random()*Math.PI*2;
        const spd=letter?(4+Math.random()*6):fast?(8+Math.random()*10):(5+Math.random()*8);
        this.vx=Math.cos(ang)*spd; this.vy=Math.sin(ang)*spd-(letter?2:3.5);
        this.life=1; this.dec=letter?(.008+Math.random()*.009):(.013+Math.random()*.018);
        this.sz=letter?(13+Math.random()*8):fast?(5+Math.random()*8):(6+Math.random()*9);
        this.rot=Math.random()*Math.PI*2; this.rotv=(Math.random()-.5)*.28;
    }
    update(){ this.x+=this.vx; this.y+=this.vy; this.vy+=.14; this.vx*=.97; this.life-=this.dec; this.rot+=this.rotv; }
    draw(){
        blCtx.save(); blCtx.globalAlpha=Math.max(0,this.life);
        blCtx.translate(this.x,this.y); blCtx.rotate(this.rot);
        blCtx.fillStyle=this.col; blCtx.shadowBlur=10; blCtx.shadowColor=this.col;
        if(this.letter){
            blCtx.font=`bold ${this.sz}px 'Exo 2',sans-serif`;
            blCtx.textAlign='center'; blCtx.textBaseline='middle';
            blCtx.fillText(this.letter,0,0);
        } else {
            // mix circles and rects for variety
            if(Math.random()>.5){ blCtx.beginPath(); blCtx.arc(0,0,this.sz/2,0,Math.PI*2); blCtx.fill(); }
            else { const h=this.sz/2; blCtx.fillRect(-h,-h,this.sz,this.sz); }
        }
        blCtx.restore();
    }
}
class BlRing {
    constructor(x,y,col,spd=1){ this.x=x;this.y=y;this.col=col;this.r=4;this.life=1;this.spd=spd; }
    update(){ this.r+=10*this.spd; this.life-=.075; }
    draw(){
        blCtx.save(); blCtx.globalAlpha=this.life*.75;
        blCtx.beginPath(); blCtx.arc(this.x,this.y,this.r,0,Math.PI*2);
        blCtx.strokeStyle=this.col.glow; blCtx.lineWidth=4.5-this.spd*.4;
        blCtx.shadowBlur=28; blCtx.shadowColor=this.col.glow; blCtx.stroke();
        blCtx.restore();
    }
}
class BlShock {
    constructor(x,y,col){ this.x=x;this.y=y;this.col=col;this.r=0;this.life=1; }
    update(){ this.r+=18; this.life-=.15; }
    draw(){
        blCtx.save(); blCtx.globalAlpha=this.life*.38;
        blCtx.beginPath(); blCtx.arc(this.x,this.y,this.r,0,Math.PI*2);
        blCtx.fillStyle=this.col.glow; blCtx.fill();
        blCtx.restore();
    }
}
class BlFloat {
    constructor(x,y,txt,col){ this.x=x;this.y=y;this.txt=txt;this.col=col;this.vy=-2.5;this.life=1; }
    update(){ this.y+=this.vy; this.vy*=.93; this.life-=.020; }
    draw(){
        blCtx.save(); blCtx.globalAlpha=Math.max(0,this.life);
        blCtx.fillStyle=this.col; blCtx.shadowBlur=18; blCtx.shadowColor=this.col;
        blCtx.font=`900 22px 'Exo 2',sans-serif`;
        blCtx.textAlign='center'; blCtx.textBaseline='middle';
        blCtx.fillText(this.txt,this.x,this.y); blCtx.restore();
    }
}

/* â”€â”€ Explode: lots of fragments â”€â”€ */
function blExplode(x,y,col,word){
    // 3 rings at different speeds
    blParticles.push(new BlRing(x,y,col,0.9));
    setTimeout(()=>blParticles.push(new BlRing(x,y,col,1.7)),55);
    setTimeout(()=>blParticles.push(new BlRing(x,y,col,2.8)),120);
    // shockwave
    blParticles.push(new BlShock(x,y,col));
    // main fast fragments
    for(let i=0;i<55;i++) blParticles.push(new BlPart(x,y,col.fill,null,true));
    // slower secondary fragments
    for(let i=0;i<20;i++) blParticles.push(new BlPart(x,y,col.rim,null,false));
    // rainbow drops
    const RC=['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#c77dff','#ff9f43'];
    for(let i=0;i<18;i++) blParticles.push(new BlPart(x,y,RC[i%RC.length],null,i<9));
    // letters from word â€” 3 copies each
    for(const ch of word) for(let k=0;k<3;k++) blParticles.push(new BlPart(x,y,col.glow,ch));
}

function blFlash(){
    const el=document.getElementById('bl-flash');
    el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',130);
}
function blFloatText(x,y,txt,col){ blParticles.push(new BlFloat(x,y,txt,col)); }

/* â”€â”€ Combo â”€â”€ */
function blComboMult(){ return blCombo>=5?2.0:blCombo>=3?1.5:1.0; }
function blUpdateCombo(){
    const el=document.getElementById('bl-combo');
    if(blCombo>=2){
        el.style.display='block';
        el.textContent=`ğŸ”¥ Ã—${blComboMult().toFixed(1)} COMBO ${blCombo}`;
        el.style.transform='scale(1.18)'; setTimeout(()=>el.style.transform='scale(1)',160);
    } else el.style.display='none';
}

/* â”€â”€ Hit â”€â”€ */
function blOnHit(ball,correct){
    if(!blRunning||blBalls.length===0) return;
    blShots++;
    // aim cannon toward ball (angle from bottom-centre semicircle rail)
    const cx=blW/2, cy=blH;
    const dx=ball.x-cx, dy=cy-ball.y;
    blCannon.targetAngle=Math.atan2(dx,dy);
    blFireLaser(ball.x,ball.y,ball.col);
    if(correct){
        blCombo++; if(blCombo>blMaxCombo) blMaxCombo=blCombo;
        const gain=Math.round(3*blComboMult()); blScore+=gain; blWords++;
        document.getElementById('bl-score').textContent=blScore;
        document.getElementById('bl-words').textContent=blWords;
        blUpdateCombo();
        blFloatText(ball.x,ball.y-ball.r,`+${gain}`,ball.col.glow);
        blExplode(ball.x,ball.y,ball.col,allData[blCurIdx].t);
        blSndPop(ball.col);
        if(blCombo>=3) blSndCombo(blCombo);
        if(tg) tg.HapticFeedback?.impactOccurred('medium');
        blBalls=[];
        setTimeout(blNextWord,380);
    } else {
        blCombo=0; blScore=Math.max(0,blScore-5);
        document.getElementById('bl-score').textContent=blScore;
        blUpdateCombo();
        blFloatText(ball.x,ball.y-ball.r,'-5','#e53935');
        blFlash();
        blSndWrong();
        if(tg) tg.HapticFeedback?.notificationOccurred('error');
        // shake the wrong bubble
        const startX=ball.shakeX||0;
        [8,-8,6,-6,4,-2,0].forEach((dx2,i)=>setTimeout(()=>{ball.shakeX=startX+dx2;},i*38));
    }
}

/* â”€â”€ Timer ring â”€â”€ */
function blUpdateTimer(){
    const arc=document.getElementById('bl-arc');
    const txt=document.getElementById('bl-time-txt');
    if(!arc||!txt) return;
    const pct=blTimeLeft/BL_SECS;
    arc.setAttribute('stroke-dashoffset',(2*Math.PI*20)*(1-pct));
    const col=blTimeLeft<=10?'#ff4060':blTimeLeft<=20?'#ffd93d':'#4d96ff';
    arc.setAttribute('stroke',col);
    txt.setAttribute('fill',blTimeLeft<=10?'#ff4060':blTimeLeft<=20?'#ffd93d':'white');
    txt.textContent=blTimeLeft;
}

/* â”€â”€ Tap â”€â”€ */
function blOnTap(e){
    if(!blRunning||blBalls.length===0) return;
    e.preventDefault();
    const rect=blCanvas.getBoundingClientRect();
    const src=e.touches?e.touches[0]:e;
    const px=(src.clientX-rect.left)*(blW/rect.width);
    const py=(src.clientY-rect.top)*(blH/rect.height);
    let hit=null;
    for(const b of blBalls) if(Math.hypot(px-b.x,py-b.y)<b.r+14){hit=b;break;}
    if(hit) blOnHit(hit,hit.correct);
}

/* â”€â”€ Loop â”€â”€ */
function blLoop(ts){
    if(!blRunning) return;
    const dt=Math.min((ts-blLastT)/1000,.05); blLastT=ts;
    blCtx.clearRect(0,0,blW,blH);
    blUpdateBalls(dt); blDrawBalls();
    blDrawLaser(); blDrawCannon();
    blParticles=blParticles.filter(p=>p.life>0);
    for(const p of blParticles){p.update();p.draw();}
    blRAF=requestAnimationFrame(blLoop);
}

/* â”€â”€ End with chaotic burst â”€â”€ */
function blBurstAll(balls,callback){
    if(balls.length===0){callback();return;}
    blSndGameover();
    const sorted=[...balls].sort(()=>Math.random()-.5);
    sorted.forEach((b,i)=>{
        setTimeout(()=>{
            blExplode(b.x,b.y,b.col,b.text.slice(0,4));
            blSndPop(b.col);
            if(tg) tg.HapticFeedback?.impactOccurred('rigid');
        }, i*180+Math.random()*100);
    });
    setTimeout(callback, sorted.length*180+500);
}

function blEnd(){
    clearInterval(blTicker);
    const snap=[...blBalls]; blBalls=[];
    blBurstAll(snap,()=>{
        blStop();
        const prev=getBest('blaster');
        const isNew=prev===null||blWords>prev;
        if(isNew) saveRec('blaster',blWords);
        const acc=blShots>0?Math.round(blWords/blShots*100):0;
        const comboXP=Math.max(0,(blMaxCombo-1))*5;
        const roundXP=blScore+comboXP+(isNew?20:0);
        showWin({
            title:'\u23F0 \u0412\u0440\u0435\u043c\u044f!',badgeCls:'blstr',badgeText:'\uD83E\uDDE7 \u0411\u043b\u0430\u0441\u0442\u0435\u0440',
            base:blScore,showAcc:false,acc,
            bonusLabel:'\uD83D\uDD25 \u041A\u043E\u043C\u0431\u043E-\u0431\u043E\u043D\u0443\u0441',bonus:comboXP,
            recBonus:20,roundXP,
            stats:`\u0421\u043B\u043E\u0432: ${blWords} \u00B7 \u0422\u043E\u0447\u043D\u043E\u0441\u0442\u044C: ${acc}% \u00B7 \u041C\u0430\u043A\u0441. \u043A\u043E\u043C\u0431\u043E: ${blMaxCombo}\u00D7 \u00B7 \u0420\u0435\u043A\u043E\u0440\u0434: ${getBest('blaster')} \u0441\u043B\u043E\u0432`,
            isNew,recVal:`${blWords} \u0441\u043B\u043E\u0432${prev!==null?` (\u0431\u044B\u043B\u043E ${prev})`:'  (\u043F\u0435\u0440\u0432\u044B\u0439 \u0440\u0435\u043A\u043E\u0440\u0434!)'}`,
        });
        if(isNew){sndRecord();setTimeout(celebrateRecord,120);}else{sndWin();celebrateWin();}
    });
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateSoundBtns() {
    const icon = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    ['btn-sound','btn-sound-bl'].forEach(id=>{
        const el=document.getElementById(id);
        if(el){ el.textContent=icon; el.classList.toggle('muted',!soundEnabled); }
    });
}
function toggleSound() {
    soundEnabled = !soundEnabled;
    updateSoundBtns();
    // resume AudioContext on first interaction
    if(soundEnabled && _sndCtx && _sndCtx.state==='suspended') _sndCtx.resume();
}
document.getElementById('btn-sound').addEventListener('click', toggleSound);
document.getElementById('btn-sound-bl').addEventListener('click', toggleSound);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function collectAndSend(){
    const r=getRecs();
    const p={
        action:'collect_xp',session_xp:sessionXP,
        classic_4:r['cl-4']??null,classic_6:r['cl-6']??null,classic_8:r['cl-8']??null,
        sprint_3:r['sprint-3']??null,sprint_6:r['sprint-6']??null,sprint_8:r['sprint-8']??null,blaster_record:r['blaster']??null,
    };
    if(tg) tg.sendData(JSON.stringify(p));
    else alert(`ĞĞ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ ${sessionXP} XP!\n${JSON.stringify(r,null,2)}`);
}

document.getElementById('btn-collect').addEventListener('click',collectAndSend);
document.getElementById('btn-collect-start').addEventListener('click',collectAndSend);

document.getElementById('btn-restart').addEventListener('click',()=>{
    if(currentMode==='classic') startClassic(currentPairs);
    else if(currentMode==='sprint') startSprint(SPRINT_ROWS);
    else startBlaster();
});
document.getElementById('btn-menu').addEventListener('click',goToMenu);
</script>
</body>
</html>
