<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Match Pairs</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg:          var(--tg-theme-bg-color,  #f0f4ff);
    --text:        var(--tg-theme-text-color, #111827);
    --card-bg:     var(--tg-theme-secondary-bg-color, #ffffff);
    --primary:     var(--tg-theme-button-color, #3b82f6);
    --primary-dk:  #2563eb;
    --success:     #38bdf8;
    --match-bdr:   #10b981;
    --error:       #ef4444;
    --xp:          #f59e0b;
    --sprint:      #8b5cf6;
    --sprint-dk:   #7c3aed;
    --bl-bg:       #050b18;
    --bl-cyan:     #00e5ff;
    --bl-pink:     #ff2d78;
    --bl-yellow:   #ffe600;
    --bl-green:    #00ff88;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);color:var(--text);padding:12px;
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;user-select:none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#start-screen{
    display:flex;flex-direction:column;align-items:center;
    gap:16px;width:100%;max-width:380px;padding-top:20px;
    animation:fadeUp .4s ease both;
}
#start-screen h1{font-size:2rem;text-align:center;}
.tagline{font-size:.9rem;opacity:.55;text-align:center;}

.mode-toggle{
    display:flex;width:100%;background:var(--card-bg);
    border-radius:14px;padding:4px;gap:4px;
    box-shadow:0 2px 8px rgba(0,0,0,.07);
}
.mode-btn{
    flex:1;padding:10px 6px;border:none;border-radius:10px;
    font-size:.88rem;font-weight:700;cursor:pointer;
    background:transparent;color:var(--text);opacity:.5;
    transition:background .2s,opacity .2s,color .2s;
}
.mode-btn.active-classic{background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;opacity:1;}
.mode-btn.active-sprint {background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;opacity:1;}
.mode-btn.active-blaster{background:linear-gradient(135deg,#00e5ff,#0066aa);color:#05101a;opacity:1;}

.mode-desc{
    width:100%;background:var(--card-bg);border-radius:14px;
    padding:12px 16px;font-size:.86rem;line-height:1.55;
    box-shadow:0 2px 8px rgba(0,0,0,.06);opacity:.8;
}
.level-section{width:100%;display:flex;flex-direction:column;gap:10px;}
.section-label{font-size:.7rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;opacity:.4;margin-bottom:2px;}

.btn-level{
    width:100%;padding:15px 18px;border:none;border-radius:14px;
    font-size:.98rem;font-weight:700;cursor:pointer;
    display:flex;align-items:center;justify-content:space-between;
    transition:transform .12s,box-shadow .12s;
}
.btn-level:active{transform:scale(.97);}
.btn-level.lv1   {background:linear-gradient(135deg,#3b82f6,#6366f1);color:#fff;box-shadow:0 5px 16px rgba(99,102,241,.35);}
.btn-level.lv2   {background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;box-shadow:0 5px 16px rgba(139,92,246,.35);}
.btn-level.lv3   {background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;box-shadow:0 5px 16px rgba(245,158,11,.35);}
.btn-level.sprint{background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;box-shadow:0 5px 16px rgba(139,92,246,.4);}
.btn-level.blstr {background:linear-gradient(135deg,#00e5ff,#0066aa);color:#05101a;box-shadow:0 5px 20px rgba(0,229,255,.4);}
.btn-level .lv-left{display:flex;flex-direction:column;gap:2px;text-align:left;}
.btn-level .lv-name{font-size:.98rem;}
.btn-level .lv-sub {font-size:.72rem;opacity:.8;font-weight:500;}
.btn-level .lv-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.btn-level .lv-xp   {font-size:.72rem;font-weight:700;background:rgba(255,255,255,.2);padding:2px 8px;border-radius:8px;}
.btn-level .lv-record{font-size:.68rem;opacity:.9;font-weight:600;}
.btn-level.blstr .lv-xp{background:rgba(5,16,26,.15);}

.collect-bar{
    width:100%;display:none;align-items:center;justify-content:space-between;
    gap:10px;padding:12px 16px;
    background:linear-gradient(135deg,#10b981,#059669);
    border-radius:14px;color:#fff;box-shadow:0 4px 16px rgba(16,185,129,.35);
}
.collect-bar.show{display:flex;}
.collect-bar .cb-left{display:flex;flex-direction:column;gap:2px;}
.collect-bar .cb-label{font-size:.7rem;opacity:.82;font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
.collect-bar .cb-xp{font-size:1.4rem;font-weight:800;line-height:1;}
.collect-bar .cb-btn{
    flex-shrink:0;padding:9px 14px;
    background:rgba(255,255,255,.22);border:2px solid rgba(255,255,255,.5);
    color:#fff;border-radius:10px;font-size:.88rem;font-weight:800;
    cursor:pointer;white-space:nowrap;transition:background .15s,transform .1s;
}
.collect-bar .cb-btn:active{background:rgba(255,255,255,.35);transform:scale(.96);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER (classic / sprint)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{
    display:none;justify-content:space-between;align-items:center;
    width:100%;max-width:440px;margin-bottom:12px;
    padding:10px 16px;background:var(--card-bg);
    border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);
    font-size:1.05rem;font-weight:700;
}
.header.visible{display:flex;}
#timer.warn  {color:#f59e0b;}
#timer.danger{color:var(--error);animation:blink .5s ease infinite alternate;}
@keyframes blink{to{opacity:.45;}}
.sprint-pill{
    display:inline-flex;align-items:center;gap:5px;
    background:linear-gradient(135deg,#8b5cf6,#6366f1);
    color:#fff;border-radius:20px;padding:3px 12px;
    font-size:.86rem;font-weight:700;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLASSIC GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.grid{display:none;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:440px;}
.grid.visible{display:grid;}
.grid.lv3 .card{font-size:.9rem;min-height:52px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPRINT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sprint-area{display:none;width:100%;max-width:440px;}
#sprint-area.visible{display:block;}
.sprint-cols{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.sprint-col-label{font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;opacity:.35;text-align:center;margin-bottom:5px;}
.sprint-left,.sprint-right{display:flex;flex-direction:column;gap:7px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{
    width:100%;min-height:56px;padding:11px 9px;
    display:flex;align-items:center;justify-content:center;
    text-align:center;border-radius:12px;font-size:1rem;font-weight:600;
    line-height:1.3;word-break:break-word;hyphens:auto;cursor:pointer;
    border:2px solid var(--primary);background:var(--card-bg);color:var(--text);
    box-shadow:0 2px 6px rgba(0,0,0,.07);
    transition:background .18s,border-color .18s,color .18s,transform .13s,box-shadow .18s;
}
.sprint-left .card{
    border-color:color-mix(in srgb,var(--sprint) 60%,transparent);
    background:color-mix(in srgb,var(--sprint) 7%,var(--card-bg));
}
.card:active:not(.matched):not(.wrong):not(.dealing){transform:scale(.95);}
.card.selected{
    border-color:var(--primary-dk);
    background:color-mix(in srgb,var(--primary) 14%,var(--card-bg));
    box-shadow:0 0 0 3px rgba(59,130,246,.25);transform:scale(1.04);
}
.sprint-left .card.selected{
    border-color:var(--sprint-dk);
    background:color-mix(in srgb,var(--sprint) 18%,var(--card-bg));
    box-shadow:0 0 0 3px rgba(139,92,246,.25);
}
.card.matched{
    background:var(--success);border-color:var(--match-bdr);color:#111827;
    box-shadow:0 4px 12px rgba(56,189,248,.4);cursor:default;
    animation:pop .32s cubic-bezier(.34,1.56,.64,1);
}
.card.wrong{background:var(--error);border-color:var(--error);color:#fff;animation:shake .38s ease;}
@keyframes pop  {0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}60%{transform:translateX(6px)}80%{transform:translateX(-3px)}}
@keyframes dealIn{0%{opacity:0;transform:translateY(-28px) scale(.82) rotate(var(--r))}65%{transform:translateY(5px) scale(1.05) rotate(0deg)}100%{opacity:1;transform:translateY(0) scale(1) rotate(0deg)}}
.card.dealing{animation:dealIn .42s cubic-bezier(.22,1,.36,1) both;}
@keyframes slideIn{from{opacity:0;transform:translateY(-14px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes slideOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(10px) scale(.9)}}
.card.slide-in{animation:slideIn .28s cubic-bezier(.22,1,.36,1) both;}
.card.slide-out{animation:slideOut .2s ease both;pointer-events:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#win-screen{
    display:none;flex-direction:column;align-items:center;
    gap:14px;margin-top:36px;animation:fadeUp .5s ease both;
    text-align:center;width:100%;max-width:360px;
}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
#win-screen h1{font-size:2.2rem;}
.xp-card{
    width:100%;background:var(--card-bg);border-radius:16px;
    padding:16px 20px;box-shadow:0 4px 16px rgba(0,0,0,.08);
    display:flex;flex-direction:column;gap:10px;
}
.xp-card-title{font-size:.73rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;opacity:.4;}
.xp-row{display:flex;justify-content:space-between;align-items:center;font-size:.93rem;}
.xp-row .label{opacity:.62;}
.xp-row .val{font-weight:700;}
.xp-row .val.bonus{color:var(--xp);}
.xp-row.total{border-top:1px solid rgba(0,0,0,.08);padding-top:8px;font-size:1.03rem;}
.xp-row.total .val{color:var(--match-bdr);font-size:1.2rem;}
.session-xp{
    width:100%;background:linear-gradient(135deg,#10b981,#059669);
    border-radius:14px;padding:14px 20px;
    display:flex;align-items:center;justify-content:space-between;color:#fff;
}
.session-xp .s-label{font-size:.83rem;opacity:.85;}
.session-xp .s-total{font-size:1.8rem;font-weight:800;line-height:1;}
.record-banner{
    display:none;align-items:center;gap:10px;
    background:linear-gradient(135deg,#f59e0b,#ef4444);
    color:#fff;border-radius:12px;padding:12px 16px;
    font-weight:800;font-size:1rem;width:100%;
}
.record-banner.show{display:flex;animation:recordPop .5s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes recordPop{0%{transform:scale(.7);opacity:0}100%{transform:scale(1);opacity:1}}
.record-banner .rec-icon{font-size:1.5rem;}
.record-banner .rec-text{display:flex;flex-direction:column;gap:1px;}
.record-banner .rec-title{font-size:.7rem;opacity:.85;font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
.record-banner .rec-val{font-size:1.04rem;font-weight:800;}
.level-badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 14px;border-radius:20px;font-size:.84rem;font-weight:700;color:#fff;
}
.level-badge.lv1   {background:linear-gradient(135deg,#3b82f6,#6366f1);}
.level-badge.lv2   {background:linear-gradient(135deg,#8b5cf6,#ec4899);}
.level-badge.lv3   {background:linear-gradient(135deg,#f59e0b,#ef4444);}
.level-badge.sprint{background:linear-gradient(135deg,#8b5cf6,#6366f1);}
.level-badge.blstr {background:linear-gradient(135deg,#00e5ff,#0066aa);color:#05101a;}
.win-buttons{display:flex;flex-direction:column;gap:10px;width:100%;}
.btn-collect{
    width:100%;padding:14px 20px;
    background:linear-gradient(135deg,#10b981,#059669);
    color:#fff;border:none;border-radius:14px;font-size:1.02rem;font-weight:800;
    cursor:pointer;box-shadow:0 6px 20px rgba(16,185,129,.4);
    transition:transform .12s,box-shadow .12s;
}
.btn-collect:active{transform:scale(.97);}
.btn{
    padding:13px 20px;background:var(--primary);color:#fff;border:none;
    border-radius:12px;font-size:.97rem;font-weight:700;cursor:pointer;
    box-shadow:0 4px 14px rgba(59,130,246,.38);transition:background .18s,transform .1s;
}
.btn:active{transform:scale(.95);background:var(--primary-dk);}
.btn-outline{
    padding:11px 20px;background:transparent;color:var(--primary);
    border:2px solid var(--primary);border-radius:12px;font-size:.92rem;
    font-weight:700;cursor:pointer;transition:background .18s,transform .1s;
}
.btn-outline:active{transform:scale(.95);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI (classic/sprint wins)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.confetti-piece{position:fixed;pointer-events:none;z-index:9999;border-radius:2px;animation:confettiFall var(--dur) var(--ease) var(--delay) forwards;}
@keyframes confettiFall{0%{transform:translate(0,0) rotate(0deg) scale(1);opacity:1;}80%{opacity:1;}100%{transform:translate(var(--tx),var(--ty)) rotate(var(--rot)) scale(.4);opacity:0;}}
.burst-ring{position:fixed;border-radius:50%;pointer-events:none;z-index:9998;border:3px solid var(--ring-color,#f59e0b);animation:burstRing .6s ease-out forwards;}
@keyframes burstRing{0%{transform:translate(-50%,-50%) scale(0);opacity:.9;}100%{transform:translate(-50%,-50%) scale(1);opacity:0;}}
.star-burst{position:fixed;pointer-events:none;z-index:9999;font-size:1.4rem;animation:starFly var(--dur) ease var(--delay) forwards;}
@keyframes starFly{0%{transform:translate(0,0) scale(0) rotate(0deg);opacity:1;}40%{transform:translate(var(--tx),var(--ty)) scale(1.3) rotate(var(--rot));opacity:1;}100%{transform:translate(calc(var(--tx)*1.6),calc(var(--ty)*1.6)) scale(0) rotate(calc(var(--rot)*2));opacity:0;}}
.xp-float{position:fixed;pointer-events:none;font-size:1.1rem;font-weight:800;color:var(--xp);text-shadow:0 1px 4px rgba(0,0,0,.15);animation:floatUp .9s ease forwards;z-index:100;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}80%{opacity:1;}100%{opacity:0;transform:translateY(-60px) scale(1.2);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BLASTER OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#blaster-wrap{
    display:none;position:fixed;inset:0;z-index:50;
    background:var(--bl-bg);touch-action:none;
}
#blaster-wrap.visible{display:block;}
#blaster-wrap::before{
    content:'';position:absolute;inset:0;z-index:0;pointer-events:none;
    background-image:linear-gradient(rgba(0,200,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,.04) 1px,transparent 1px);
    background-size:40px 40px;
}
#bl-canvas{position:absolute;inset:0;z-index:1;width:100%;height:100%;}

/* Blaster HUD */
#bl-hud{
    position:absolute;top:0;left:0;right:0;z-index:10;
    display:flex;justify-content:space-between;align-items:center;
    padding:10px 16px 6px;
    background:linear-gradient(180deg,rgba(5,11,24,.95) 80%,transparent);
    font-family:'Orbitron',monospace;
}
.bl-box{display:flex;flex-direction:column;align-items:center;gap:1px;}
.bl-lbl{font-size:.58rem;letter-spacing:.12em;text-transform:uppercase;color:var(--bl-cyan);opacity:.6;}
.bl-val{font-size:1.05rem;font-weight:700;color:#fff;text-shadow:0 0 10px var(--bl-cyan);}
/* Blaster word */
#bl-word-panel{
    position:absolute;left:50%;transform:translateX(-50%);
    top:74px;z-index:10;text-align:center;white-space:nowrap;
}
.bl-word-lbl{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--bl-pink);opacity:.7;}
#bl-word{
    font-family:'Orbitron',monospace;font-size:1.5rem;font-weight:900;
    color:#fff;text-shadow:0 0 18px var(--bl-cyan),0 0 36px var(--bl-cyan);
    letter-spacing:.06em;animation:blPulse 2s ease infinite;
}
@keyframes blPulse{0%,100%{text-shadow:0 0 18px var(--bl-cyan),0 0 36px var(--bl-cyan);}50%{text-shadow:0 0 28px var(--bl-cyan),0 0 56px var(--bl-cyan),0 0 2px #fff;}}
/* Combo */
#bl-combo{
    position:absolute;top:126px;left:50%;transform:translateX(-50%);z-index:10;
    font-family:'Orbitron',monospace;font-size:.88rem;font-weight:900;
    color:var(--bl-yellow);text-shadow:0 0 14px var(--bl-yellow);
    white-space:nowrap;display:none;
}
/* Flash */
#bl-flash{position:absolute;inset:0;z-index:9;pointer-events:none;opacity:0;transition:opacity .08s;background:rgba(255,45,120,.25);}

/* Error */
#error-screen{display:none;flex-direction:column;align-items:center;gap:10px;margin-top:60px;color:var(--error);font-size:1rem;text-align:center;}
</style>
</head>
<body>

<!-- â•â•â• START SCREEN â•â•â• -->
<div id="start-screen">
    <div><h1>ğŸ§  Match Pairs</h1><p class="tagline">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¸ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ</p></div>

    <div class="mode-toggle">
        <button class="mode-btn active-classic" id="btn-mc" onclick="setMode('classic')">ğŸ¯ ĞšĞ»Ğ°ÑÑĞ¸ĞºĞ°</button>
        <button class="mode-btn"               id="btn-ms" onclick="setMode('sprint')">âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚</button>
        <button class="mode-btn"               id="btn-mb" onclick="setMode('blaster')">ğŸ’¥ Ğ‘Ğ»Ğ°ÑÑ‚ĞµÑ€</button>
    </div>

    <div class="mode-desc" id="mode-desc"></div>

    <div class="level-section" id="lbs-classic">
        <div class="section-label">Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸</div>
        <button class="btn-level lv1" data-pairs="4" data-mode="classic">
            <span class="lv-left"><span class="lv-name">â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹</span><span class="lv-sub">4 Ğ¿Ğ°Ñ€Ñ‹</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 15 XP</span><span class="lv-record" id="rc4"></span></span>
        </button>
        <button class="btn-level lv2" data-pairs="6" data-mode="classic">
            <span class="lv-left"><span class="lv-name">â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹</span><span class="lv-sub">6 Ğ¿Ğ°Ñ€</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 25 XP</span><span class="lv-record" id="rc6"></span></span>
        </button>
        <button class="btn-level lv3" data-pairs="8" data-mode="classic">
            <span class="lv-left"><span class="lv-name">â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹</span><span class="lv-sub">8 Ğ¿Ğ°Ñ€</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 35 XP</span><span class="lv-record" id="rc8"></span></span>
        </button>
    </div>

    <div class="level-section" id="lbs-sprint" style="display:none">
        <div class="section-label">60 ÑĞµĞºÑƒĞ½Ğ´ Â· Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº</div>
        <button class="btn-level sprint" data-mode="sprint">
            <span class="lv-left"><span class="lv-name">âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚</span><span class="lv-sub">8 ÑĞ»Ğ¾Ğ² Â· Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 50 XP</span><span class="lv-record" id="rcs"></span></span>
        </button>
    </div>

    <div class="level-section" id="lbs-blaster" style="display:none">
        <div class="section-label">60 ÑĞµĞºÑƒĞ½Ğ´ Â· Ğ°Ñ€ĞºĞ°Ğ´Ğ°</div>
        <button class="btn-level blstr" data-mode="blaster">
            <span class="lv-left"><span class="lv-name">ğŸ’¥ Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ</span><span class="lv-sub">4â†’6 ÑˆĞ°Ñ€Ğ¾Ğ² Â· ĞºĞ¾Ğ¼Ğ±Ğ¾ Â· Ğ»Ğ°Ğ·ĞµÑ€</span></span>
            <span class="lv-right"><span class="lv-xp">Ğ´Ğ¾ 60+ XP</span><span class="lv-record" id="rcb"></span></span>
        </button>
    </div>

    <div class="collect-bar" id="collect-bar">
        <div class="cb-left">
            <span class="cb-label">ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾ Ğ·Ğ° ÑĞµÑÑĞ¸Ñ</span>
            <span class="cb-xp"><span id="cb-val">0</span> XP</span>
        </div>
        <button class="cb-btn" id="btn-collect-start">ğŸ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
</div>

<!-- â•â•â• CLASSIC/SPRINT HEADER â•â•â• -->
<div class="header" id="header">
    <div id="timer">â± 00:00</div>
    <div id="level-label"></div>
    <div id="score">ĞŸĞ°Ñ€Ñ‹: 0 / â€”</div>
</div>

<!-- â•â•â• CLASSIC GRID â•â•â• -->
<div class="grid" id="grid"></div>

<!-- â•â•â• SPRINT AREA â•â•â• -->
<div id="sprint-area">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:5px">
        <div class="sprint-col-label">Ğ¡Ğ»Ğ¾Ğ²Ğ¾</div>
        <div class="sprint-col-label">ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´</div>
    </div>
    <div class="sprint-cols">
        <div class="sprint-left"  id="sprint-left"></div>
        <div class="sprint-right" id="sprint-right"></div>
    </div>
</div>

<!-- â•â•â• WIN SCREEN â•â•â• -->
<div id="win-screen">
    <h1 id="win-title">ğŸ‰ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!</h1>
    <div id="win-badge" class="level-badge"></div>
    <div class="xp-card">
        <div class="xp-card-title">XP Ğ·Ğ° ÑÑ‚Ğ¾Ñ‚ Ñ€Ğ°ÑƒĞ½Ğ´</div>
        <div class="xp-row" id="row-base">
            <span class="label">Ğ‘Ğ°Ğ·Ğ°</span>
            <span class="val" id="xp-base">0 XP</span>
        </div>
        <div class="xp-row" id="row-acc">
            <span class="label">Ã— Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ (<span id="xp-acc-pct">0</span>%)</span>
            <span class="val" id="xp-acc-val">0 XP</span>
        </div>
        <div class="xp-row" id="row-bonus">
            <span class="label" id="bonus-label">âš¡ Ğ‘Ğ¾Ğ½ÑƒÑ</span>
            <span class="val bonus" id="xp-bonus">+0 XP</span>
        </div>
        <div class="xp-row" id="row-record" style="display:none">
            <span class="label">ğŸ† Ğ‘Ğ¾Ğ½ÑƒÑ Ñ€ĞµĞºĞ¾Ñ€Ğ´Ğ°</span>
            <span class="val bonus">+20 XP</span>
        </div>
        <div class="xp-row total">
            <span class="label"><b>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ·Ğ° Ñ€Ğ°ÑƒĞ½Ğ´</b></span>
            <span class="val" id="xp-total">0 XP</span>
        </div>
    </div>
    <div class="session-xp">
        <div><div class="s-label">ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾ Ğ·Ğ° ÑĞµÑÑĞ¸Ñ</div><div class="s-total" id="sess-total">0 XP</div></div>
        <div style="font-size:2rem">ğŸ†</div>
    </div>
    <div class="record-banner" id="record-banner">
        <span class="rec-icon">ğŸ†</span>
        <span class="rec-text">
            <span class="rec-title">ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!</span>
            <span class="rec-val" id="record-val"></span>
        </span>
    </div>
    <p style="font-size:.93rem;opacity:.7" id="final-stats"></p>
    <div class="win-buttons">
        <button class="btn-collect" id="btn-collect">ğŸ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ <span id="collect-label">0</span> XP Ğ¸ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸</button>
        <button class="btn"         id="btn-restart">â–¶ Ğ¡Ñ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°</button>
        <button class="btn-outline" id="btn-menu">â† Ğ’ Ğ¼ĞµĞ½Ñ</button>
    </div>
</div>

<div id="error-screen">
    <p>âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.<br>ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.</p>
</div>

<!-- â•â•â• BLASTER OVERLAY â•â•â• -->
<div id="blaster-wrap">
    <canvas id="bl-canvas"></canvas>
    <div id="bl-hud">
        <div class="bl-box"><span class="bl-lbl">Ğ¡Ñ‡Ñ‘Ñ‚</span><span class="bl-val" id="bl-score">0</span></div>
        <div class="bl-box">
            <svg viewBox="0 0 48 48" width="46" height="46">
                <circle cx="24" cy="24" r="20" fill="none" stroke="rgba(0,229,255,.15)" stroke-width="4"/>
                <circle id="bl-arc" cx="24" cy="24" r="20" fill="none" stroke="#00e5ff" stroke-width="4"
                        stroke-dasharray="125.6" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-90 24 24)"/>
                <text x="24" y="29" text-anchor="middle" font-family="Orbitron,monospace"
                      font-size="11" font-weight="700" fill="white" id="bl-time-txt">60</text>
            </svg>
        </div>
        <div class="bl-box"><span class="bl-lbl">Ğ¡Ğ»Ğ¾Ğ²Ğ°</span><span class="bl-val" id="bl-words">0</span></div>
    </div>
    <div id="bl-combo"></div>
    <div id="bl-word-panel">
        <div class="bl-word-lbl">ĞŸĞµÑ€ĞµĞ²ĞµĞ´Ğ¸ ÑĞ»Ğ¾Ğ²Ğ¾</div>
        <div id="bl-word">â€”</div>
    </div>
    <div id="bl-flash"></div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TELEGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let allData = [];
try {
    const raw = new URLSearchParams(window.location.search).get('data');
    if (raw) {
        allData = JSON.parse(decodeURIComponent(raw));
        if (!Array.isArray(allData) || !allData.length) throw 0;
    } else {
        allData = [
            {w:'Hund',t:'Ğ¡Ğ¾Ğ±Ğ°ĞºĞ°'},{w:'Katze',t:'ĞšĞ¾ÑˆĞºĞ°'},{w:'Haus',t:'Ğ”Ğ¾Ğ¼'},
            {w:'Auto',t:'ĞœĞ°ÑˆĞ¸Ğ½Ğ°'},{w:'Baum',t:'Ğ”ĞµÑ€ĞµĞ²Ğ¾'},{w:'Apfel',t:'Ğ¯Ğ±Ğ»Ğ¾ĞºĞ¾'},
            {w:'Wasser',t:'Ğ’Ğ¾Ğ´Ğ°'},{w:'Brot',t:'Ğ¥Ğ»ĞµĞ±'},{w:'Schule',t:'Ğ¨ĞºĞ¾Ğ»Ğ°'},
            {w:'Buch',t:'ĞšĞ½Ğ¸Ğ³Ğ°'},{w:'Kind',t:'Ğ ĞµĞ±Ñ‘Ğ½Ğ¾Ğº'},{w:'Freund',t:'Ğ”Ñ€ÑƒĞ³'},
            {w:'Tisch',t:'Ğ¡Ñ‚Ğ¾Ğ»'},{w:'Stuhl',t:'Ğ¡Ñ‚ÑƒĞ»'},{w:'Stadt',t:'Ğ“Ğ¾Ñ€Ğ¾Ğ´'},
            {w:'Land',t:'Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ°'},{w:'Sonne',t:'Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğµ'},{w:'Mond',t:'Ğ›ÑƒĞ½Ğ°'},
            {w:'Feuer',t:'ĞĞ³Ğ¾Ğ½ÑŒ'},{w:'Eis',t:'Ğ›Ñ‘Ğ´'},
        ];
    }
} catch(e) {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('error-screen').style.display = 'flex';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shuffle(a) {
    const b=[...a];
    for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]];}
    return b;
}
function pickWords(n) { return shuffle(allData).slice(0, Math.min(n, allData.length)); }
function fmt(s) { return `${String(0|s/60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
function rnd(a,b) { return a + Math.random()*(b-a); }
function levelInfo(p) {
    if(p<=4) return {cls:'lv1',label:'â­ Ğ›Ñ‘Ğ³ĞºĞ¸Ğ¹',gcls:''};
    if(p<=6) return {cls:'lv2',label:'â­â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹',gcls:''};
    return         {cls:'lv3',label:'â­â­â­ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹',gcls:'lv3'};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECORDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const RKEY = 'mp_records_v3';
function getRecs()    { try{ return JSON.parse(localStorage.getItem(RKEY))||{}; }catch{return{};} }
function saveRec(k,v) { const r=getRecs(); r[k]=v; localStorage.setItem(RKEY,JSON.stringify(r)); }
function getBest(k)   { return getRecs()[k]??null; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION XP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sessionXP = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   XP CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const XP_CL = { 4:{base:10,spd:5,sec:15}, 6:{base:15,spd:10,sec:25}, 8:{base:20,spd:15,sec:35} };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MODE_DESCS = {
    classic: '<b>ğŸ¯ ĞšĞ»Ğ°ÑÑĞ¸ĞºĞ°</b> â€” Ğ½Ğ°Ğ¹Ğ´Ğ¸ Ğ²ÑĞµ Ğ¿Ğ°Ñ€Ñ‹. Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ²Ñ€ĞµĞ¼Ñ Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ. Ğ§ĞµĞ¼ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ â€” Ñ‚ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ XP.',
    sprint:  '<b>âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚</b> â€” 60 ÑĞµĞºÑƒĞ½Ğ´, Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº (8 Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ñ…). Ğ£Ğ³Ğ°Ğ´Ğ°Ğ¹ ĞºĞ°Ğº Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿Ğ°Ñ€.',
    blaster: '<b>ğŸ’¥ Ğ‘Ğ»Ğ°ÑÑ‚ĞµÑ€</b> â€” 60 ÑĞµĞºÑƒĞ½Ğ´ Ğ°Ñ€ĞºĞ°Ğ´Ñ‹! Ğ¨Ğ°Ñ€Ñ‹ Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°Ğ¼Ğ¸ Ğ»ĞµÑ‚Ğ°ÑÑ‚ Ğ¿Ğ¾ ÑĞºÑ€Ğ°Ğ½Ñƒ. Ğ¡Ñ‚Ñ€ĞµĞ»ÑĞ¹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ. ĞšĞ¾Ğ¼Ğ±Ğ¾ ÑƒĞ¼Ğ½Ğ¾Ğ¶Ğ°ĞµÑ‚ XP!',
};
let currentMode = 'classic';
let currentPairs = 4;

function setMode(m) {
    currentMode = m;
    document.getElementById('btn-mc').className = 'mode-btn'+(m==='classic' ?' active-classic':'');
    document.getElementById('btn-ms').className = 'mode-btn'+(m==='sprint'  ?' active-sprint' :'');
    document.getElementById('btn-mb').className = 'mode-btn'+(m==='blaster' ?' active-blaster':'');
    document.getElementById('mode-desc').innerHTML = MODE_DESCS[m]||'';
    document.getElementById('lbs-classic').style.display = m==='classic' ?'':'none';
    document.getElementById('lbs-sprint').style.display  = m==='sprint'  ?'':'none';
    document.getElementById('lbs-blaster').style.display = m==='blaster' ?'':'none';
}
setMode('classic');
updateRecordLabels();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECORD LABELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateRecordLabels() {
    const map = {rc4:'cl-4',rc6:'cl-6',rc8:'cl-8',rcs:'sprint',rcb:'blaster'};
    for(const [id,key] of Object.entries(map)) {
        const el=document.getElementById(id); if(!el) continue;
        const v=getBest(key);
        if(v===null){el.textContent='';continue;}
        el.textContent = (key==='sprint'||key==='blaster') ? `ğŸ† ${v} ÑĞ»Ğ¾Ğ²` : `ğŸ† ${fmt(v)}`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEVEL BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.btn-level').forEach(btn => {
    btn.addEventListener('click', () => {
        const m = btn.dataset.mode;
        const p = parseInt(btn.dataset.pairs)||8;
        if(m==='classic') startClassic(p);
        else if(m==='sprint') startSprint();
        else startBlaster();
    });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HIDE ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hideAll() {
    document.getElementById('start-screen').style.display='none';
    document.getElementById('win-screen').style.display='none';
    document.getElementById('header').classList.remove('visible');
    document.getElementById('grid').className='grid';
    document.getElementById('sprint-area').classList.remove('visible');
    document.getElementById('sprint-left').innerHTML='';
    document.getElementById('sprint-right').innerHTML='';
    document.getElementById('blaster-wrap').classList.remove('visible');
}

function goToMenu() {
    blasterStop();
    clearInterval(classicTimer);
    clearInterval(sprintTimer);
    hideAll();
    document.getElementById('start-screen').style.display='flex';
    updateRecordLabels();
    syncCollectBar();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLECT BAR (start screen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncCollectBar() {
    const bar=document.getElementById('collect-bar');
    document.getElementById('cb-val').textContent=sessionXP;
    sessionXP>0 ? bar.classList.add('show') : bar.classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED WIN SCREEN FILL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showWin({title,badgeCls,badgeText,base,showAcc,acc,bonusLabel,bonus,recBonus,roundXP,stats,isNew,recVal}) {
    sessionXP += roundXP;
    document.getElementById('win-title').textContent = title;
    const badge=document.getElementById('win-badge');
    badge.textContent=badgeText; badge.className=`level-badge ${badgeCls}`;
    document.getElementById('xp-base').textContent   = `${base} XP`;
    document.getElementById('row-acc').style.display = showAcc?'':'none';
    document.getElementById('xp-acc-pct').textContent = acc;
    document.getElementById('xp-acc-val').textContent = `${Math.round(base*(acc/100))} XP`;
    document.getElementById('bonus-label').textContent = bonusLabel;
    document.getElementById('xp-bonus').textContent   = `+${bonus} XP`;
    document.getElementById('row-record').style.display = isNew?'':'none';
    document.getElementById('xp-total').textContent  = `+${roundXP} XP`;
    document.getElementById('sess-total').textContent = `${sessionXP} XP`;
    document.getElementById('collect-label').textContent = sessionXP;
    document.getElementById('final-stats').textContent = stats;
    const banner=document.getElementById('record-banner');
    if(isNew){
        document.getElementById('record-val').textContent=recVal;
        banner.classList.add('show');
    } else banner.classList.remove('show');
    document.getElementById('win-screen').style.display='flex';
    updateRecordLabels();
    if(tg) tg.HapticFeedback?.notificationOccurred(isNew?'success':'warning');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CC=['#f59e0b','#ef4444','#3b82f6','#10b981','#8b5cf6','#ec4899','#38bdf8','#fff'];
const CS=['â­','ğŸŒŸ','âœ¨','ğŸ’«','ğŸ‰','ğŸ†'];
function launchConfetti(cx,cy,n=60){
    for(let i=0;i<n;i++){
        const el=document.createElement('div');el.classList.add('confetti-piece');
        const ang=rnd(0,Math.PI*2),pow=rnd(120,380);
        const tx=Math.cos(ang)*pow,ty=Math.sin(ang)*pow-rnd(80,200);
        const dur=rnd(.7,1.4),delay=rnd(0,.18),sz=rnd(7,14);
        const circ=Math.random()>.5;
        el.style.cssText=`left:${cx}px;top:${cy}px;width:${sz}px;height:${sz*(circ?1:rnd(.4,1))}px;
            background:${CC[0|Math.random()*CC.length]};border-radius:${circ?'50%':'2px'};
            --tx:${tx}px;--ty:${ty}px;--rot:${rnd(-720,720)}deg;--dur:${dur}s;--delay:${delay}s;--ease:ease-out;`;
        document.body.appendChild(el);
        setTimeout(()=>el.remove(),(dur+delay)*1000+100);
    }
}
function launchRing(cx,cy,color,sz=160){
    const el=document.createElement('div');el.classList.add('burst-ring');
    el.style.cssText=`left:${cx}px;top:${cy}px;width:${sz}px;height:${sz}px;--ring-color:${color};`;
    document.body.appendChild(el);setTimeout(()=>el.remove(),700);
}
function launchStars(cx,cy,n=8){
    for(let i=0;i<n;i++){
        const el=document.createElement('div');el.classList.add('star-burst');
        const ang=(Math.PI*2/n)*i,pow=rnd(80,160);
        const dur=rnd(.6,1),delay=rnd(0,.1);
        el.textContent=CS[0|Math.random()*CS.length];
        el.style.cssText=`left:${cx}px;top:${cy}px;--tx:${Math.cos(ang)*pow}px;--ty:${Math.sin(ang)*pow}px;--rot:${rnd(-180,180)}deg;--dur:${dur}s;--delay:${delay}s;`;
        document.body.appendChild(el);setTimeout(()=>el.remove(),(dur+delay)*1000+100);
    }
}
function celebrateRecord(){
    const cx=innerWidth/2,cy=innerHeight/2;
    launchRing(cx,cy,'#f59e0b',200);launchStars(cx,cy,10);launchConfetti(cx,cy,70);
    setTimeout(()=>{launchRing(cx*.3,cy*.6,'#3b82f6',120);launchConfetti(cx*.3,cy*.6,30);},180);
    setTimeout(()=>{launchRing(cx*1.7,cy*.6,'#ec4899',120);launchConfetti(cx*1.7,cy*.6,30);},320);
    setTimeout(()=>{launchStars(cx,cy*.3,8);launchConfetti(cx,cy*.8,40);},500);
}
function celebrateWin(){
    const cx=innerWidth/2,cy=innerHeight/2;
    launchRing(cx,cy,'#38bdf8',160);launchConfetti(cx,cy,45);launchStars(cx,cy,6);
}
function spawnXPFloat(el,txt){
    const r=el.getBoundingClientRect();
    const d=document.createElement('div');d.classList.add('xp-float');
    d.textContent=txt;d.style.left=r.left+r.width/2-20+'px';d.style.top=r.top+scrollY-10+'px';
    document.body.appendChild(d);setTimeout(()=>d.remove(),950);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  CLASSIC MODE  â–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let classicTimer=null, classicSecs=0, classicStarted=false;
let matchedPairs=0, attempts=0;
let selectedCard=null, lockBoard=false;
let gameData=[];

function startClassic(pairs) {
    currentMode='classic'; currentPairs=pairs;
    gameData=pickWords(pairs);
    clearInterval(classicTimer);
    classicSecs=0; classicStarted=false; matchedPairs=0; attempts=0;
    selectedCard=null; lockBoard=false;
    const info=levelInfo(pairs);
    hideAll();
    document.getElementById('header').classList.add('visible');
    const g=document.getElementById('grid');
    g.className='grid visible'+(info.gcls?' '+info.gcls:'');
    document.getElementById('timer').textContent='â± 00:00';
    document.getElementById('timer').className='';
    document.getElementById('score').textContent=`ĞŸĞ°Ñ€Ñ‹: 0 / ${pairs}`;
    document.getElementById('level-label').textContent=info.label;
    buildClassicCards();
}
function buildClassicCards(){
    const g=document.getElementById('grid');
    g.innerHTML='';lockBoard=true;
    const L=shuffle(gameData.map((p,i)=>({id:i,t:p.w})));
    const R=shuffle(gameData.map((p,i)=>({id:i,t:p.t})));
    for(let i=0;i<gameData.length;i++){
        [L[i],R[i]].forEach((item,s)=>{
            const c=document.createElement('div');
            c.classList.add('card','dealing');c.dataset.id=item.id;
            c.style.setProperty('--r',rnd(-5,5).toFixed(1)+'deg');
            c.style.animationDelay=(i*2+s)*40+'ms';
            c.textContent=item.t;c.addEventListener('click',onClassicClick);
            g.appendChild(c);
        });
    }
    setTimeout(()=>{lockBoard=false;g.querySelectorAll('.card').forEach(c=>c.classList.remove('dealing'));},(gameData.length*2-1)*40+420);
}
function startClassicTimer(){
    if(classicStarted) return; classicStarted=true;
    classicTimer=setInterval(()=>{
        classicSecs++;
        document.getElementById('timer').textContent=`â± ${fmt(classicSecs)}`;
    },1000);
}
function onClassicClick(){
    if(lockBoard||this.classList.contains('matched')) return;
    startClassicTimer();
    if(this===selectedCard){this.classList.remove('selected');selectedCard=null;return;}
    if(!selectedCard){this.classList.add('selected');selectedCard=this;return;}
    const A=selectedCard,B=this;
    A.classList.remove('selected');selectedCard=null;attempts++;
    if(A.dataset.id===B.dataset.id){
        A.classList.add('matched');B.classList.add('matched');
        A.removeEventListener('click',onClassicClick);B.removeEventListener('click',onClassicClick);
        matchedPairs++;
        document.getElementById('score').textContent=`ĞŸĞ°Ñ€Ñ‹: ${matchedPairs} / ${currentPairs}`;
        if(tg) tg.HapticFeedback?.impactOccurred('light');
        spawnXPFloat(B,'âœ¨');
        if(matchedPairs===currentPairs) setTimeout(winClassic,450);
    } else {
        lockBoard=true;A.classList.add('wrong');B.classList.add('wrong');
        if(tg) tg.HapticFeedback?.notificationOccurred('error');
        setTimeout(()=>{A.classList.remove('wrong');B.classList.remove('wrong');lockBoard=false;},700);
    }
}
function winClassic(){
    clearInterval(classicTimer);
    document.getElementById('header').classList.remove('visible');
    document.getElementById('grid').className='grid';
    const acc=attempts>0?Math.round(currentPairs/attempts*100):100;
    const cfg=XP_CL[currentPairs]||XP_CL[8];
    const key=`cl-${currentPairs}`;
    const prev=getBest(key);
    const isNew=prev===null||classicSecs<prev;
    if(isNew) saveRec(key,classicSecs);
    const earned=Math.round(cfg.base*(acc/100));
    const spd=classicSecs<=cfg.sec?cfg.spd:0;
    const roundXP=earned+spd+(isNew?20:0);
    const info=levelInfo(currentPairs);
    showWin({
        title:'ğŸ‰ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!',badgeCls:info.cls,badgeText:info.label,
        base:cfg.base,showAcc:true,acc,bonusLabel:'âš¡ Ğ‘Ğ¾Ğ½ÑƒÑ Ğ·Ğ° ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ',bonus:spd,
        recBonus:20,roundXP,
        stats:`Ğ’Ñ€ĞµĞ¼Ñ: ${fmt(classicSecs)} Â· Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${acc}% Â· Ğ ĞµĞºĞ¾Ñ€Ğ´: ${fmt(getBest(key))}`,
        isNew,recVal:`${fmt(classicSecs)}${prev!==null?` (Ğ±Ñ‹Ğ»Ğ¾ ${fmt(prev)})`:'  (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!)'}`,
    });
    isNew?setTimeout(celebrateRecord,120):celebrateWin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  SPRINT MODE  â–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SPRINT_ROWS=8;
let sprintTimer=null,sprintLeft2=0,sprintStarted=false;
let sprintScore=0,sprintAttempts=0,sprintQueue2=[],sprintQPos=0;
let sprintSlots=[],sprintSelL=null,sprintSelR=null;

function startSprint(){
    currentMode='sprint';
    clearInterval(sprintTimer);
    sprintLeft2=60;sprintStarted=false;sprintScore=0;sprintAttempts=0;
    sprintSelL=null;sprintSelR=null;
    sprintQueue2=shuffle(allData.map((_,i)=>i));sprintQPos=0;
    hideAll();
    document.getElementById('header').classList.add('visible');
    document.getElementById('sprint-area').classList.add('visible');
    document.getElementById('timer').textContent='â± 1:00';
    document.getElementById('timer').className='';
    document.getElementById('score').innerHTML='<span class="sprint-pill">âš¡ <span id="sp-score">0</span> Ğ¿Ğ°Ñ€</span>';
    document.getElementById('level-label').textContent='âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚';
    const SL=document.getElementById('sprint-left'),SR=document.getElementById('sprint-right');
    SL.innerHTML='';SR.innerHTML='';sprintSlots=[];
    for(let i=0;i<SPRINT_ROWS;i++){
        const id=nextSprintId();
        const el=makeSpCard(allData[id].w,'left',i*30);
        el.addEventListener('click',()=>onSprintL(i));
        SL.appendChild(el);sprintSlots.push({id,el});
    }
    rebuildSprintRight(sprintSlots.map(s=>s.id));
    document.getElementById('sprint-area').addEventListener('click',startSprintTimer,{once:true});
}
function nextSprintId(){
    if(sprintQPos>=sprintQueue2.length){sprintQueue2=shuffle(allData.map((_,i)=>i));sprintQPos=0;}
    return sprintQueue2[sprintQPos++];
}
function makeSpCard(text,side,delay=0){
    const el=document.createElement('div');
    el.classList.add('card','slide-in');
    el.style.animationDelay=delay+'ms';
    el.textContent=text;
    setTimeout(()=>el.classList.remove('slide-in'),delay+300);
    return el;
}
function rebuildSprintRight(ids){
    const SR=document.getElementById('sprint-right');
    SR.innerHTML='';
    shuffle([...ids]).forEach((id,i)=>{
        const el=makeSpCard(allData[id].t,'right',i*30);
        el.addEventListener('click',()=>onSprintR(id,el));
        SR.appendChild(el);
    });
}
function onSprintL(idx){
    if(!sprintStarted||lockBoard) return;
    const slot=sprintSlots[idx];
    if(!slot||slot.el.classList.contains('matched')) return;
    if(sprintSelL?.idx===idx){slot.el.classList.remove('selected');sprintSelL=null;return;}
    if(sprintSelL) sprintSelL.el.classList.remove('selected');
    sprintSelL={idx,id:slot.id,el:slot.el};slot.el.classList.add('selected');
    if(sprintSelR) checkSprintPair();
}
function onSprintR(id,el){
    if(!sprintStarted||lockBoard||el.classList.contains('matched')) return;
    if(sprintSelR?.el===el){el.classList.remove('selected');sprintSelR=null;return;}
    if(sprintSelR) sprintSelR.el.classList.remove('selected');
    sprintSelR={id,el};el.classList.add('selected');
    if(sprintSelL) checkSprintPair();
}
function checkSprintPair(){
    const L=sprintSelL,R=sprintSelR;
    L.el.classList.remove('selected');R.el.classList.remove('selected');
    sprintSelL=null;sprintSelR=null;sprintAttempts++;
    if(L.id===R.id){
        L.el.classList.add('matched');R.el.classList.add('matched');
        sprintScore++;
        const sv=document.getElementById('sp-score');if(sv)sv.textContent=sprintScore;
        if(tg) tg.HapticFeedback?.impactOccurred('light');
        spawnXPFloat(R.el,'âœ¨');
        setTimeout(()=>replaceSprintSlot(L.idx,L.el,R.el),650);
    } else {
        lockBoard=true;L.el.classList.add('wrong');R.el.classList.add('wrong');
        if(tg) tg.HapticFeedback?.notificationOccurred('error');
        setTimeout(()=>{L.el.classList.remove('wrong');R.el.classList.remove('wrong');lockBoard=false;},600);
    }
}
function replaceSprintSlot(idx,oldL,matchedR){
    matchedR.classList.add('slide-out');setTimeout(()=>matchedR.remove(),220);
    oldL.classList.add('slide-out');
    const newId=nextSprintId();
    setTimeout(()=>{
        const newEl=makeSpCard(allData[newId].w,'left');
        newEl.addEventListener('click',()=>onSprintL(idx));
        document.getElementById('sprint-left').replaceChild(newEl,oldL);
        sprintSlots[idx]={id:newId,el:newEl};
        const newR=makeSpCard(allData[newId].t,'right');
        newR.addEventListener('click',()=>onSprintR(newId,newR));
        const SR=document.getElementById('sprint-right');
        const kids=[...SR.children].filter(c=>!c.classList.contains('slide-out'));
        const before=kids[0|Math.random()*(kids.length+1)];
        if(before)SR.insertBefore(newR,before);else SR.appendChild(newR);
    },220);
}
function startSprintTimer(){
    sprintStarted=true;lockBoard=false;
    sprintTimer=setInterval(()=>{
        sprintLeft2--;
        const m=0|sprintLeft2/60,s=String(sprintLeft2%60).padStart(2,'0');
        const td=document.getElementById('timer');
        td.textContent=`â± ${m}:${s}`;
        td.classList.toggle('warn',sprintLeft2<=20&&sprintLeft2>10);
        td.classList.toggle('danger',sprintLeft2<=10);
        if(sprintLeft2<=0) endSprint();
    },1000);
}
function endSprint(){
    clearInterval(sprintTimer);
    document.getElementById('header').classList.remove('visible');
    document.getElementById('sprint-area').classList.remove('visible');
    const prev=getBest('sprint');
    const isNew=prev===null||sprintScore>prev;
    if(isNew) saveRec('sprint',sprintScore);
    const acc=sprintAttempts>0?Math.round(sprintScore/sprintAttempts*100):0;
    const roundXP=30+sprintScore+(isNew?20:0);
    showWin({
        title:'â° Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾!',badgeCls:'sprint',badgeText:'âš¡ Ğ¡Ğ¿Ñ€Ğ¸Ğ½Ñ‚',
        base:30,showAcc:false,acc,bonusLabel:'âš¡ Ğ‘Ğ¾Ğ½ÑƒÑ Ğ·Ğ° Ğ¿Ğ°Ñ€Ñ‹',bonus:sprintScore,
        recBonus:20,roundXP,
        stats:`Ğ£Ğ³Ğ°Ğ´Ğ°Ğ½Ğ¾: ${sprintScore} Ğ¿Ğ°Ñ€ Â· Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${acc}% Â· Ğ ĞµĞºĞ¾Ñ€Ğ´: ${getBest('sprint')} ÑĞ»Ğ¾Ğ²`,
        isNew,recVal:`${sprintScore} Ğ¿Ğ°Ñ€${prev!==null?` (Ğ±Ñ‹Ğ»Ğ¾ ${prev})`:'  (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!)'}`,
    });
    isNew?setTimeout(celebrateRecord,120):celebrateWin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  BLASTER MODE  â–ˆâ–ˆâ–ˆâ–ˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BL_SECS    = 60;
const BALL_ZONES = {top:152, bottom:100};
const BL_COLORS  = [
    {fill:'#00e5ff',glow:'#00e5ff',text:'#001a1f'},
    {fill:'#ff2d78',glow:'#ff2d78',text:'#fff'},
    {fill:'#ffe600',glow:'#ffe600',text:'#1a1500'},
    {fill:'#00ff88',glow:'#00ff88',text:'#001a0d'},
    {fill:'#bf5fff',glow:'#bf5fff',text:'#fff'},
    {fill:'#ff8c00',glow:'#ff8c00',text:'#1a0a00'},
];

let blCanvas, blCtx, blW, blH;
let blRunning=false, blTimeLeft=BL_SECS, blTicker=null;
let blScore=0, blWords=0, blShots=0, blCombo=0, blMaxCombo=0;
let blWordQueue=[], blQPos=0, blCurIdx=0;
let blBalls=[], blParticles=[], blLaser=null;
let blCannon={x:0,y:0,angle:0,targetAngle:0,flash:0};
let blRAF=null, blLastT=0;

function blInit(){
    blCanvas=document.getElementById('bl-canvas');
    blCtx=blCanvas.getContext('2d');
    blResize();
    window.addEventListener('resize',blResize);
    blCanvas.addEventListener('pointerdown',blOnTap);
}
function blResize(){
    if(!blCanvas) return;
    blW=blCanvas.width=window.innerWidth;
    blH=blCanvas.height=window.innerHeight;
}

function startBlaster(){
    currentMode='blaster';
    if(!blCanvas) blInit();
    blRunning=false;cancelAnimationFrame(blRAF);clearInterval(blTicker);
    blScore=0;blWords=0;blShots=0;blCombo=0;blMaxCombo=0;
    blBalls=[];blParticles=[];blLaser=null;blTimeLeft=BL_SECS;
    blWordQueue=shuffle(allData.map((_,i)=>i));blQPos=0;
    hideAll();
    document.getElementById('blaster-wrap').classList.add('visible');
    blResize();
    document.getElementById('bl-score').textContent='0';
    document.getElementById('bl-words').textContent='0';
    document.getElementById('bl-combo').style.display='none';
    blUpdateTimer();
    blNextWord();
    blRunning=true;
    blTicker=setInterval(()=>{
        blTimeLeft--;blUpdateTimer();
        if(blTimeLeft<=0) blEnd();
    },1000);
    blLastT=performance.now();
    blRAF=requestAnimationFrame(blLoop);
}
function blStop(){
    blRunning=false;cancelAnimationFrame(blRAF);clearInterval(blTicker);
    document.getElementById('blaster-wrap').classList.remove('visible');
}
function blasterStop(){blStop();}

function blNextWordId(){
    if(blQPos>=blWordQueue.length){blWordQueue=shuffle(allData.map((_,i)=>i));blQPos=0;}
    return blWordQueue[blQPos++];
}
function blNextWord(){
    blCurIdx=blNextWordId();
    document.getElementById('bl-word').textContent=allData[blCurIdx].w;
    blSpawnBalls();
}

/* â”€â”€ Balls â”€â”€ */
function blBallCount(){ const e=BL_SECS-blTimeLeft;return e<20?4:e<40?5:6; }
function blBallSpeed(){ return 1+(BL_SECS-blTimeLeft)*0.016; }

function blSpawnBalls(){
    const n=blBallCount(),sm=blBallSpeed();
    const wrong=shuffle(allData.filter((_,i)=>i!==blCurIdx).map(d=>d.t)).slice(0,n-1);
    const cols=shuffle([...BL_COLORS]).slice(0,n);
    const cpos=0|Math.random()*n;
    blBalls=[];
    let wi=0;
    for(let i=0;i<n;i++){
        const isCor=i===cpos;
        const txt=isCor?allData[blCurIdx].t:wrong[wi++];
        const r=38;
        const topPad=BALL_ZONES.top+r+10;
        const botPad=blH-BALL_ZONES.bottom-r-10;
        const bx=r+10+Math.random()*(blW-r*2-20);
        const by=topPad+Math.random()*Math.max(0,botPad-topPad);
        blBalls.push({
            id:i,text:txt,correct:isCor,col:cols[i],r,
            bx,by,x:bx,y:by,
            ax:30+Math.random()*50,ay:20+Math.random()*35,
            fx:0.35+Math.random()*0.55,fy:0.3+Math.random()*0.5,
            px:Math.random()*Math.PI*2,py:Math.random()*Math.PI*2,
            t:0,sm,opacity:0,pulse:0,
        });
    }
}

function blUpdateBalls(dt){
    for(const b of blBalls){
        b.t+=dt*b.sm;
        b.opacity=Math.min(1,b.opacity+dt*3);
        b.x=b.bx+Math.sin(b.t*b.fx+b.px)*b.ax;
        b.y=b.by+Math.cos(b.t*b.fy+b.py)*b.ay;
        b.x=Math.max(b.r+8,Math.min(blW-b.r-8,b.x));
        b.y=Math.max(BALL_ZONES.top+b.r+8,Math.min(blH-BALL_ZONES.bottom-b.r-8,b.y));
        if(b.correct) b.pulse=Math.sin(Date.now()*0.004)*0.06;
    }
}
function blDrawBalls(){
    for(const b of blBalls){
        blCtx.save();blCtx.globalAlpha=b.opacity;
        const r=b.r*(1+b.pulse);
        // outer glow
        const og=blCtx.createRadialGradient(b.x,b.y,r*.2,b.x,b.y,r*1.6);
        og.addColorStop(0,b.col.fill+'77');og.addColorStop(1,'transparent');
        blCtx.beginPath();blCtx.arc(b.x,b.y,r*1.6,0,Math.PI*2);
        blCtx.fillStyle=og;blCtx.fill();
        // body
        const bg=blCtx.createRadialGradient(b.x-r*.3,b.y-r*.3,r*.1,b.x,b.y,r);
        bg.addColorStop(0,'#ffffff44');bg.addColorStop(.4,b.col.fill);bg.addColorStop(1,b.col.fill+'aa');
        blCtx.beginPath();blCtx.arc(b.x,b.y,r,0,Math.PI*2);
        blCtx.fillStyle=bg;blCtx.shadowBlur=22;blCtx.shadowColor=b.col.glow;
        blCtx.fill();blCtx.shadowBlur=0;
        blCtx.strokeStyle='#ffffff33';blCtx.lineWidth=1.5;blCtx.stroke();
        // text
        blCtx.fillStyle=b.col.text;
        blCtx.font=`bold ${Math.max(10,14-Math.max(0,b.text.length-6))}px 'Exo 2',sans-serif`;
        blCtx.textAlign='center';blCtx.textBaseline='middle';
        blCtx.fillText(b.text,b.x,b.y);
        blCtx.restore();
    }
}

/* â”€â”€ Cannon â”€â”€ */
function blDrawCannon(){
    const cx=blW/2,cy=blH-60;
    blCannon.x=cx;blCannon.y=cy;
    blCannon.angle+=(blCannon.targetAngle-blCannon.angle)*.25;
    blCtx.save();blCtx.translate(cx,cy);
    // base glow
    const bg=blCtx.createRadialGradient(0,0,10,0,0,50);
    bg.addColorStop(0,'rgba(0,229,255,.18)');bg.addColorStop(1,'transparent');
    blCtx.beginPath();blCtx.arc(0,0,50,0,Math.PI*2);blCtx.fillStyle=bg;blCtx.fill();
    // base
    blCtx.beginPath();blCtx.ellipse(0,0,40,14,0,0,Math.PI*2);
    blCtx.fillStyle='#0a2030';blCtx.strokeStyle='rgba(0,229,255,.6)';blCtx.lineWidth=2;
    blCtx.fill();blCtx.stroke();
    // barrel
    blCtx.rotate(blCannon.angle);
    blCtx.beginPath();blCtx.rect(-8,-50,16,36);
    const bg2=blCtx.createLinearGradient(-8,0,8,0);
    bg2.addColorStop(0,'#0a3040');bg2.addColorStop(.5,'#1a6080');bg2.addColorStop(1,'#0a3040');
    blCtx.fillStyle=bg2;blCtx.strokeStyle='rgba(0,229,255,.7)';blCtx.lineWidth=1.5;
    blCtx.shadowBlur=12;blCtx.shadowColor='#00e5ff';blCtx.fill();blCtx.stroke();blCtx.shadowBlur=0;
    // tip
    if(blCannon.flash>0){
        blCtx.beginPath();blCtx.arc(0,-50,14,0,Math.PI*2);
        blCtx.fillStyle=`rgba(0,229,255,${blCannon.flash})`;blCtx.fill();
        blCannon.flash=Math.max(0,blCannon.flash-.08);
    } else {
        blCtx.beginPath();blCtx.arc(0,-50,6,0,Math.PI*2);
        blCtx.fillStyle='rgba(0,229,255,.5)';blCtx.fill();
    }
    blCtx.restore();
}

/* â”€â”€ Laser â”€â”€ */
function blFireLaser(tx,ty,col){
    blLaser={x1:blCannon.x,y1:blCannon.y-50,x2:tx,y2:ty,col,life:1};
    blCannon.flash=1;
}
function blDrawLaser(){
    if(!blLaser) return;
    blCtx.save();blCtx.globalAlpha=blLaser.life;
    blCtx.strokeStyle=blLaser.col.fill;blCtx.shadowBlur=20;blCtx.shadowColor=blLaser.col.glow;
    blCtx.lineWidth=3;blCtx.beginPath();blCtx.moveTo(blLaser.x1,blLaser.y1);blCtx.lineTo(blLaser.x2,blLaser.y2);blCtx.stroke();
    blCtx.strokeStyle='#fff';blCtx.lineWidth=1;blCtx.shadowBlur=0;
    blCtx.beginPath();blCtx.moveTo(blLaser.x1,blLaser.y1);blCtx.lineTo(blLaser.x2,blLaser.y2);blCtx.stroke();
    blCtx.restore();
    blLaser.life-=.12;if(blLaser.life<=0)blLaser=null;
}

/* â”€â”€ Particles â”€â”€ */
class BlPart {
    constructor(x,y,col,letter){
        this.x=x;this.y=y;this.col=col;this.letter=letter||'';
        const ang=Math.random()*Math.PI*2;
        const spd=letter?(2+Math.random()*4):(3+Math.random()*6);
        this.vx=Math.cos(ang)*spd;this.vy=Math.sin(ang)*spd-(letter?1:2);
        this.life=1;this.dec=letter?(.012+Math.random()*.012):(.02+Math.random()*.03);
        this.sz=letter?(10+Math.random()*6):(3+Math.random()*6);
        this.rot=Math.random()*Math.PI*2;this.rotv=(Math.random()-.5)*.2;
    }
    update(){this.x+=this.vx;this.y+=this.vy;this.vy+=.12;this.vx*=.98;this.life-=this.dec;this.rot+=this.rotv;}
    draw(){
        blCtx.save();blCtx.globalAlpha=Math.max(0,this.life);
        blCtx.translate(this.x,this.y);blCtx.rotate(this.rot);
        blCtx.fillStyle=this.col;blCtx.shadowBlur=8;blCtx.shadowColor=this.col;
        if(this.letter){
            blCtx.font=`bold ${this.sz}px 'Orbitron',monospace`;
            blCtx.textAlign='center';blCtx.textBaseline='middle';
            blCtx.fillText(this.letter,0,0);
        } else {
            const h=this.sz/2;blCtx.fillRect(-h,-h,this.sz,this.sz);
        }
        blCtx.restore();
    }
}
class BlRing {
    constructor(x,y,col){this.x=x;this.y=y;this.col=col;this.r=0;this.life=1;}
    update(){this.r+=8;this.life-=.1;}
    draw(){
        blCtx.save();blCtx.globalAlpha=this.life*.6;
        blCtx.beginPath();blCtx.arc(this.x,this.y,this.r,0,Math.PI*2);
        blCtx.strokeStyle=this.col.glow;blCtx.lineWidth=3;
        blCtx.shadowBlur=20;blCtx.shadowColor=this.col.glow;blCtx.stroke();
        blCtx.restore();
    }
}
class BlFloat {
    constructor(x,y,txt,col){this.x=x;this.y=y;this.txt=txt;this.col=col;this.vy=-2;this.life=1;}
    update(){this.y+=this.vy;this.vy*=.94;this.life-=.022;}
    draw(){
        blCtx.save();blCtx.globalAlpha=Math.max(0,this.life);
        blCtx.fillStyle=this.col;blCtx.shadowBlur=16;blCtx.shadowColor=this.col;
        blCtx.font=`bold 20px 'Orbitron',monospace`;
        blCtx.textAlign='center';blCtx.textBaseline='middle';
        blCtx.fillText(this.txt,this.x,this.y);blCtx.restore();
    }
}
function blExplode(x,y,col,word){
    for(const ch of word) for(let k=0;k<2;k++) blParticles.push(new BlPart(x,y,col.glow,ch));
    for(let i=0;i<28;i++) blParticles.push(new BlPart(x,y,col.fill));
    blParticles.push(new BlRing(x,y,col));
}
function blFlash(){
    const el=document.getElementById('bl-flash');
    el.style.opacity='1';setTimeout(()=>el.style.opacity='0',120);
}
function blFloatText(x,y,txt,col){blParticles.push(new BlFloat(x,y,txt,col));}

/* â”€â”€ Combo â”€â”€ */
function blComboMult(){return blCombo>=5?2.0:blCombo>=3?1.5:1.0;}
function blUpdateCombo(){
    const el=document.getElementById('bl-combo');
    if(blCombo>=2){
        el.style.display='block';
        el.textContent=`ğŸ”¥ Ã—${blComboMult().toFixed(1)} COMBO ${blCombo}`;
        el.style.transform='scale(1.15)';setTimeout(()=>el.style.transform='scale(1)',150);
    } else el.style.display='none';
}

/* â”€â”€ Hit â”€â”€ */
function blOnHit(ball,correct){
    if(!blRunning||blBalls.length===0) return;
    blShots++;
    const dx=ball.x-blCannon.x,dy=(blCannon.y-50)-ball.y;
    blCannon.targetAngle=Math.atan2(-dy,dx)-Math.PI/2;
    blFireLaser(ball.x,ball.y,ball.col);
    if(correct){
        blCombo++;if(blCombo>blMaxCombo)blMaxCombo=blCombo;
        const gain=Math.round(10*blComboMult());blScore+=gain;blWords++;
        document.getElementById('bl-score').textContent=blScore;
        document.getElementById('bl-words').textContent=blWords;
        blUpdateCombo();
        blFloatText(ball.x,ball.y-ball.r,`+${gain}`,ball.col.glow);
        blExplode(ball.x,ball.y,ball.col,allData[blCurIdx].t);
        if(tg) tg.HapticFeedback?.impactOccurred('medium');
        setTimeout(blNextWord,400);
    } else {
        blCombo=0;blScore=Math.max(0,blScore-5);
        document.getElementById('bl-score').textContent=blScore;
        blUpdateCombo();
        blFloatText(ball.x,ball.y-ball.r,'-5','#ff2d78');
        blExplode(ball.x,ball.y,ball.col,'âœ—');
        blFlash();
        if(tg) tg.HapticFeedback?.notificationOccurred('error');
    }
    blBalls=[];
}

/* â”€â”€ Timer ring â”€â”€ */
function blUpdateTimer(){
    const arc=document.getElementById('bl-arc');
    const txt=document.getElementById('bl-time-txt');
    if(!arc||!txt) return;
    const pct=blTimeLeft/BL_SECS;
    arc.setAttribute('stroke-dashoffset',(2*Math.PI*20)*(1-pct));
    const col=blTimeLeft<=10?'#ff2d78':blTimeLeft<=20?'#ffe600':'#00e5ff';
    arc.setAttribute('stroke',col);txt.setAttribute('fill',blTimeLeft<=10?'#ff2d78':blTimeLeft<=20?'#ffe600':'white');
    txt.textContent=blTimeLeft;
}

/* â”€â”€ Tap â”€â”€ */
function blOnTap(e){
    if(!blRunning||blBalls.length===0) return;
    e.preventDefault();
    const rect=blCanvas.getBoundingClientRect();
    const src=e.touches?e.touches[0]:e;
    const px=(src.clientX-rect.left)*(blW/rect.width);
    const py=(src.clientY-rect.top)*(blH/rect.height);
    let hit=null;
    for(const b of blBalls) if(Math.hypot(px-b.x,py-b.y)<b.r+10){hit=b;break;}
    if(hit) blOnHit(hit,hit.correct);
}

/* â”€â”€ Loop â”€â”€ */
function blLoop(ts){
    if(!blRunning) return;
    const dt=Math.min((ts-blLastT)/1000,.05);blLastT=ts;
    blCtx.clearRect(0,0,blW,blH);
    blUpdateBalls(dt);blDrawBalls();
    blDrawLaser();blDrawCannon();
    blParticles=blParticles.filter(p=>p.life>0);
    for(const p of blParticles){p.update();p.draw();}
    blRAF=requestAnimationFrame(blLoop);
}

/* â”€â”€ End â”€â”€ */
function blEnd(){
    blStop();
    const prev=getBest('blaster');
    const isNew=prev===null||blWords>prev;
    if(isNew) saveRec('blaster',blWords);
    const acc=blShots>0?Math.round(blWords/blShots*100):0;
    const comboXP=Math.max(0,(blMaxCombo-1))*5;
    const roundXP=blScore+comboXP+(isNew?20:0);
    showWin({
        title:'â° Ğ’Ñ€ĞµĞ¼Ñ!',badgeCls:'blstr',badgeText:'ğŸ’¥ Ğ‘Ğ»Ğ°ÑÑ‚ĞµÑ€',
        base:blScore,showAcc:false,acc,
        bonusLabel:`ğŸ”¥ ĞšĞ¾Ğ¼Ğ±Ğ¾-Ğ±Ğ¾Ğ½ÑƒÑ (Ğ¼Ğ°ĞºÑ. Ã—${blComboMult().toFixed(1)})`,bonus:comboXP,
        recBonus:20,roundXP,
        stats:`Ğ¡Ğ»Ğ¾Ğ²: ${blWords} Â· Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${acc}% Â· ĞœĞ°ĞºÑ. ĞºĞ¾Ğ¼Ğ±Ğ¾: ${blMaxCombo}Ã— Â· Ğ ĞµĞºĞ¾Ñ€Ğ´: ${getBest('blaster')} ÑĞ»Ğ¾Ğ²`,
        isNew,recVal:`${blWords} ÑĞ»Ğ¾Ğ²${prev!==null?` (Ğ±Ñ‹Ğ»Ğ¾ ${prev})`:'  (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€ĞµĞºĞ¾Ñ€Ğ´!)'}`,
    });
    isNew?setTimeout(celebrateRecord,120):celebrateWin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function collectAndSend(){
    const r=getRecs();
    const p={
        action:'collect_xp',session_xp:sessionXP,
        classic_4:r['cl-4']??null,classic_6:r['cl-6']??null,classic_8:r['cl-8']??null,
        sprint_record:r['sprint']??null,blaster_record:r['blaster']??null,
    };
    if(tg) tg.sendData(JSON.stringify(p));
    else alert(`ĞĞ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ ${sessionXP} XP!\n${JSON.stringify(r,null,2)}`);
}

document.getElementById('btn-collect').addEventListener('click',collectAndSend);
document.getElementById('btn-collect-start').addEventListener('click',collectAndSend);

document.getElementById('btn-restart').addEventListener('click',()=>{
    if(currentMode==='classic') startClassic(currentPairs);
    else if(currentMode==='sprint') startSprint();
    else startBlaster();
});
document.getElementById('btn-menu').addEventListener('click',goToMenu);
</script>
</body>
</html>
